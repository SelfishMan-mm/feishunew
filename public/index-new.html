<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®å¤åˆ¶å·¥å…·</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f7fa;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: #1e40af;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }

    /* åŸºç¡€é…ç½®åŒº */
    .config-section {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .config-header {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .config-item {
      flex: 1;
      border: 2px solid #dc2626;
      border-radius: 6px;
      padding: 16px;
    }

    .config-label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #dc2626;
      margin-bottom: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    /* å­—æ®µåŒ¹é…åŒº */
    .field-section {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .field-header {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 16px;
    }

    .field-item {
      flex: 1;
    }

    .field-item label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }

    .field-item select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: white;
      font-size: 14px;
    }

    /* æ•°æ®é¢„è§ˆåŒº */
    .preview-section {
      padding: 20px;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .get-records-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .get-records-btn:hover {
      background: #1d4ed8;
    }

    .records-info {
      font-size: 14px;
      color: #6b7280;
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
    }

    .records-table th {
      background: #f9fafb;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
    }

    .records-table td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
    }

    .records-table tr:hover {
      background: #f9fafb;
    }

    .record-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* æ“ä½œæŒ‰é’®åŒº */
    .actions-section {
      padding: 20px;
      background: #f9fafb;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-copy-selected {
      background: #2563eb;
      color: white;
    }

    .btn-copy-selected:hover {
      background: #1d4ed8;
    }

    .btn-copy-all {
      background: #059669;
      color: white;
    }

    .btn-copy-all:hover {
      background: #047857;
    }

    .btn-test {
      background: #7c3aed;
      color: white;
    }

    .btn-test:hover {
      background: #6d28d9;
    }

    .btn-delete {
      background: #dc2626;
      color: white;
    }

    .btn-delete:hover {
      background: #b91c1c;
    }

    /* çŠ¶æ€å±•ç¤º */
    .status {
      padding: 16px 20px;
      background: #f0f9ff;
      border-left: 4px solid #0ea5e9;
      margin: 16px 20px;
      border-radius: 4px;
    }

    .status.success {
      background: #f0fdf4;
      border-color: #22c55e;
    }

    .status.error {
      background: #fef2f2;
      border-color: #ef4444;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .config-header {
        flex-direction: column;
      }
      
      .field-header {
        flex-direction: column;
      }
      
      .actions-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .action-btn {
        justify-content: center;
      }
    }

    /* éšè—çŠ¶æ€ */
    .hidden {
      display: none;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      pointer-events: none;
      opacity: 0.6;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ ‡é¢˜åŒº -->
    <div class="header">
      ğŸ”„ é£ä¹¦å¤šç»´è¡¨æ ¼è·¨è¡¨å¤åˆ¶å·¥å…·
    </div>

    <!-- åŸºç¡€é…ç½®åŒº -->
    <div class="config-section">
      <div class="config-header">
        <div class="config-item">
          <span class="config-label">æºè¡¨å¤åˆ¶è®°å½•</span>
          <div class="form-group">
            <input type="text" id="baseId" placeholder="BaseID (åº”ç”¨ä»¤ç‰Œ)">
            <input type="text" id="sourceTableId" placeholder="æºè¡¨ID">
            <input type="text" id="token" placeholder="PersonalBaseToken">
          </div>
        </div>
        <div class="config-item">
          <span class="config-label">ç›®æ ‡è¡¨æ ¼</span>
          <div class="form-group">
            <input type="text" id="targetTableId" placeholder="ç›®æ ‡è¡¨ID">
          </div>
        </div>
      </div>
    </div>

    <!-- å­—æ®µåŒ¹é…åŒº -->
    <div class="field-section">
      <div class="field-header">
        <div class="field-item">
          <label>é…ç½®å­—æ®µ</label>
          <button id="loadFields" class="get-records-btn">åŠ è½½å­—æ®µä¿¡æ¯</button>
        </div>
        <div class="field-item">
          <label>åŒ¹é…å€¼</label>
          <select id="fieldMapping">
            <option value="auto">è‡ªåŠ¨åŒ¹é…åŒåå­—æ®µ</option>
            <option value="manual">æ‰‹åŠ¨é…ç½®å­—æ®µæ˜ å°„</option>
          </select>
        </div>
      </div>
      
      <!-- å­—æ®µæ˜ å°„è¯¦æƒ… -->
      <div id="fieldMappingDetails" class="hidden">
        <div id="fieldMappingContainer"></div>
      </div>
    </div>

    <!-- æ•°æ®é¢„è§ˆåŒº -->
    <div class="preview-section">
      <div class="preview-header">
        <button id="getRecords" class="get-records-btn">
          <span>ğŸ“‹</span> è·å–å·¦ä¾§é€‰ä¸­çš„æ‰€æœ‰è®°å½•
        </button>
        <div class="records-info">
          å·²é€‰: <span id="selectedCount">0</span> æ¡æ•°æ®
        </div>
      </div>

      <!-- è®°å½•è¡¨æ ¼ -->
      <div id="recordsContainer" class="hidden">
        <table class="records-table">
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="selectAll" class="record-checkbox">
              </th>
              <th>åºå·</th>
              <th>ä¸»è¦å­—æ®µ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="recordsTable">
            <!-- åŠ¨æ€ç”Ÿæˆè®°å½•è¡Œ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’®åŒº -->
    <div class="actions-section">
      <button id="deleteSelected" class="action-btn btn-delete">
        <span>ğŸ—‘ï¸</span> æ‰¹é‡åˆ é™¤
      </button>
      <button id="copySelected" class="action-btn btn-copy-selected">
        <span>ğŸ“‹</span> æ•´è¡Œå¤åˆ¶
      </button>
      <button id="copyAll" class="action-btn btn-copy-all">
        <span>ğŸ“Š</span> æ•´è¡¨å¤åˆ¶
      </button>
      <button id="testCopy" class="action-btn btn-test">
        <span>ğŸ§ª</span> æµ‹è¯•å¤åˆ¶
      </button>
    </div>

    <!-- çŠ¶æ€æ˜¾ç¤ºåŒº -->
    <div id="status" class="status hidden">
      <div id="statusMessage"></div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    let sourceFields = [];
    let targetFields = [];
    let records = [];
    let selectedRecords = new Set();

    // DOM å…ƒç´ 
    const elements = {
      baseId: document.getElementById('baseId'),
      sourceTableId: document.getElementById('sourceTableId'),
      targetTableId: document.getElementById('targetTableId'),
      token: document.getElementById('token'),
      loadFields: document.getElementById('loadFields'),
      fieldMapping: document.getElementById('fieldMapping'),
      fieldMappingDetails: document.getElementById('fieldMappingDetails'),
      getRecords: document.getElementById('getRecords'),
      recordsContainer: document.getElementById('recordsContainer'),
      recordsTable: document.getElementById('recordsTable'),
      selectAll: document.getElementById('selectAll'),
      selectedCount: document.getElementById('selectedCount'),
      deleteSelected: document.getElementById('deleteSelected'),
      copySelected: document.getElementById('copySelected'),
      copyAll: document.getElementById('copyAll'),
      testCopy: document.getElementById('testCopy'),
      status: document.getElementById('status'),
      statusMessage: document.getElementById('statusMessage')
    };

    // å·¥å…·å‡½æ•°
    function showStatus(message, type = 'info') {
      elements.status.className = `status ${type}`;
      elements.statusMessage.textContent = message;
      elements.status.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          elements.status.classList.add('hidden');
        }, 3000);
      }
    }

    function setLoading(element, loading) {
      if (loading) {
        element.classList.add('loading');
        const spinner = document.createElement('span');
        spinner.className = 'spinner';
        element.appendChild(spinner);
      } else {
        element.classList.remove('loading');
        const spinner = element.querySelector('.spinner');
        if (spinner) spinner.remove();
      }
    }

    function getConfig() {
      return {
        baseId: elements.baseId.value.trim(),
        sourceTableId: elements.sourceTableId.value.trim(),
        targetTableId: elements.targetTableId.value.trim(),
        token: elements.token.value.trim()
      };
    }

    function validateConfig() {
      const config = getConfig();
      if (!config.baseId || !config.sourceTableId || !config.targetTableId || !config.token) {
        showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é…ç½®é¡¹', 'error');
        return false;
      }
      return true;
    }

    // åŠ è½½å­—æ®µä¿¡æ¯
    async function loadFields() {
      if (!validateConfig()) return;

      setLoading(elements.loadFields, true);
      try {
        const config = getConfig();
        const response = await fetch('/api/fields', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.success) {
          sourceFields = result.sourceFields;
          targetFields = result.targetFields;
          updateFieldMapping();
          showStatus(`åŠ è½½æˆåŠŸ: æºè¡¨ ${sourceFields.length} ä¸ªå­—æ®µ, ç›®æ ‡è¡¨ ${targetFields.length} ä¸ªå­—æ®µ`, 'success');
        } else {
          showStatus(`åŠ è½½å¤±è´¥: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
      setLoading(elements.loadFields, false);
    }

    // æ›´æ–°å­—æ®µæ˜ å°„
    function updateFieldMapping() {
      if (elements.fieldMapping.value === 'manual') {
        elements.fieldMappingDetails.classList.remove('hidden');
        renderFieldMapping();
      } else {
        elements.fieldMappingDetails.classList.add('hidden');
      }
    }

    // æ¸²æŸ“å­—æ®µæ˜ å°„
    function renderFieldMapping() {
      const container = document.getElementById('fieldMappingContainer');
      container.innerHTML = '<h4>å­—æ®µæ˜ å°„é…ç½®:</h4>';
      
      sourceFields.forEach(sourceField => {
        const row = document.createElement('div');
        row.style.cssText = 'display: flex; gap: 12px; margin-bottom: 8px; align-items: center;';
        
        row.innerHTML = `
          <span style="width: 150px; font-size: 14px;">${sourceField.name}</span>
          <span style="width: 20px; text-align: center;">â†’</span>
          <select style="flex: 1; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
            <option value="">ä¸æ˜ å°„</option>
            ${targetFields.map(tf => 
              `<option value="${tf.id}" ${tf.name === sourceField.name ? 'selected' : ''}>${tf.name}</option>`
            ).join('')}
          </select>
        `;
        
        container.appendChild(row);
      });
    }

    // è·å–è®°å½•æ•°æ®
    async function getRecords() {
      if (!validateConfig()) return;

      setLoading(elements.getRecords, true);
      try {
        const config = getConfig();
        const response = await fetch('/api/get-records', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.success) {
          records = result.records;
          renderRecords();
          showStatus(`è·å–æˆåŠŸ: ${records.length} æ¡è®°å½•`, 'success');
        } else {
          showStatus(`è·å–å¤±è´¥: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
      setLoading(elements.getRecords, false);
    }

    // æ¸²æŸ“è®°å½•è¡¨æ ¼
    function renderRecords() {
      elements.recordsTable.innerHTML = '';
      elements.recordsContainer.classList.remove('hidden');
      
      records.forEach((record, index) => {
        const row = document.createElement('tr');
        const firstFieldValue = Object.values(record.fields)[0] || 'æ— æ•°æ®';
        
        row.innerHTML = `
          <td><input type="checkbox" class="record-checkbox" data-record-id="${record.record_id}"></td>
          <td>${index + 1}</td>
          <td>${firstFieldValue}</td>
          <td>
            <button onclick="viewRecord('${record.record_id}')" style="padding: 4px 8px; font-size: 12px; border: none; background: #e5e7eb; border-radius: 4px; cursor: pointer;">æŸ¥çœ‹</button>
          </td>
        `;
        
        elements.recordsTable.appendChild(row);
      });

      // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
      bindCheckboxEvents();
    }

    // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
    function bindCheckboxEvents() {
      const checkboxes = document.querySelectorAll('.record-checkbox[data-record-id]');
      
      checkboxes.forEach(cb => {
        cb.addEventListener('change', (e) => {
          const recordId = e.target.dataset.recordId;
          if (e.target.checked) {
            selectedRecords.add(recordId);
          } else {
            selectedRecords.delete(recordId);
          }
          updateSelectedCount();
          updateSelectAllState();
        });
      });

      elements.selectAll.addEventListener('change', (e) => {
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
          const recordId = cb.dataset.recordId;
          if (e.target.checked) {
            selectedRecords.add(recordId);
          } else {
            selectedRecords.delete(recordId);
          }
        });
        updateSelectedCount();
      });
    }

    // æ›´æ–°é€‰ä¸­è®¡æ•°
    function updateSelectedCount() {
      elements.selectedCount.textContent = selectedRecords.size;
    }

    // æ›´æ–°å…¨é€‰çŠ¶æ€
    function updateSelectAllState() {
      const checkboxes = document.querySelectorAll('.record-checkbox[data-record-id]');
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      
      if (checkedCount === 0) {
        elements.selectAll.indeterminate = false;
        elements.selectAll.checked = false;
      } else if (checkedCount === checkboxes.length) {
        elements.selectAll.indeterminate = false;
        elements.selectAll.checked = true;
      } else {
        elements.selectAll.indeterminate = true;
      }
    }

    // å¤åˆ¶é€‰ä¸­è®°å½•
    async function copySelected() {
      if (selectedRecords.size === 0) {
        showStatus('è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„è®°å½•', 'error');
        return;
      }

      if (!validateConfig()) return;

      setLoading(elements.copySelected, true);
      try {
        const config = getConfig();
        const selectedRecordIds = Array.from(selectedRecords);
        
        const response = await fetch('/api/copy-selected', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...config,
            recordIds: selectedRecordIds,
            fieldMapping: elements.fieldMapping.value
          })
        });

        const result = await response.json();
        if (result.success) {
          showStatus(`å¤åˆ¶æˆåŠŸ: ${result.copiedCount} æ¡è®°å½•`, 'success');
          selectedRecords.clear();
          updateSelectedCount();
          // é‡æ–°è·å–è®°å½•åˆ·æ–°çŠ¶æ€
          await getRecords();
        } else {
          showStatus(`å¤åˆ¶å¤±è´¥: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
      setLoading(elements.copySelected, false);
    }

    // æ•´è¡¨å¤åˆ¶
    async function copyAll() {
      if (!validateConfig()) return;

      const confirmed = confirm('ç¡®å®šè¦å¤åˆ¶æ•´ä¸ªè¡¨æ ¼çš„æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–ç›®æ ‡è¡¨çš„ç°æœ‰æ•°æ®ã€‚');
      if (!confirmed) return;

      setLoading(elements.copyAll, true);
      try {
        const config = getConfig();
        const response = await fetch('/api/copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.success) {
          showStatus(`æ•´è¡¨å¤åˆ¶æˆåŠŸ: ${result.copiedCount} æ¡è®°å½•`, 'success');
        } else {
          showStatus(`å¤åˆ¶å¤±è´¥: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
      setLoading(elements.copyAll, false);
    }

    // æµ‹è¯•å¤åˆ¶
    async function testCopy() {
      if (!validateConfig()) return;

      setLoading(elements.testCopy, true);
      try {
        const config = getConfig();
        const response = await fetch('/api/test-copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.success) {
          showStatus(`æµ‹è¯•æˆåŠŸ: å·²å¤åˆ¶ 1 æ¡è®°å½•`, 'success');
        } else {
          showStatus(`æµ‹è¯•å¤±è´¥: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      }
      setLoading(elements.testCopy, false);
    }

    // åˆ é™¤é€‰ä¸­è®°å½•
    async function deleteSelected() {
      if (selectedRecords.size === 0) {
        showStatus('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è®°å½•', 'error');
        return;
      }

      const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedRecords.size} æ¡è®°å½•å—ï¼Ÿ`);
      if (!confirmed) return;

      showStatus('åˆ é™¤åŠŸèƒ½æš‚æœªå®ç°', 'error');
    }

    // æŸ¥çœ‹è®°å½•è¯¦æƒ…
    function viewRecord(recordId) {
      const record = records.find(r => r.record_id === recordId);
      if (record) {
        alert(`è®°å½•è¯¦æƒ…:\n${JSON.stringify(record.fields, null, 2)}`);
      }
    }

    // äº‹ä»¶ç»‘å®š
    elements.loadFields.addEventListener('click', loadFields);
    elements.fieldMapping.addEventListener('change', updateFieldMapping);
    elements.getRecords.addEventListener('click', getRecords);
    elements.copySelected.addEventListener('click', copySelected);
    elements.copyAll.addEventListener('click', copyAll);
    elements.testCopy.addEventListener('click', testCopy);
    elements.deleteSelected.addEventListener('click', deleteSelected);

    // åˆå§‹åŒ–
    showStatus('è¯·å¡«å†™é…ç½®ä¿¡æ¯å¹¶åŠ è½½å­—æ®µ', 'info');
  </script>
</body>
</html>
