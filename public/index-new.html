<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>飞书多维表格数据复制工具</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f7fa;
      color: #333;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: #1e40af;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
    }

    /* 基础配置区 */
    .config-section {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .config-header {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .config-item {
      flex: 1;
      border: 2px solid #dc2626;
      border-radius: 6px;
      padding: 16px;
    }

    .config-label {
      display: block;
      font-size: 16px;
      font-weight: 600;
      color: #dc2626;
      margin-bottom: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    /* 字段匹配区 */
    .field-section {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .field-header {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 16px;
    }

    .field-item {
      flex: 1;
    }

    .field-item label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }

    .field-item select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: white;
      font-size: 14px;
    }

    /* 数据预览区 */
    .preview-section {
      padding: 20px;
    }

    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .get-records-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .get-records-btn:hover {
      background: #1d4ed8;
    }

    .records-info {
      font-size: 14px;
      color: #6b7280;
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
    }

    .records-table th {
      background: #f9fafb;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e5e7eb;
    }

    .records-table td {
      padding: 12px;
      border-bottom: 1px solid #f3f4f6;
    }

    .records-table tr:hover {
      background: #f9fafb;
    }

    .record-checkbox {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* 操作按钮区 */
    .actions-section {
      padding: 20px;
      background: #f9fafb;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .action-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-copy-selected {
      background: #2563eb;
      color: white;
    }

    .btn-copy-selected:hover {
      background: #1d4ed8;
    }

    .btn-copy-all {
      background: #059669;
      color: white;
    }

    .btn-copy-all:hover {
      background: #047857;
    }

    .btn-test {
      background: #7c3aed;
      color: white;
    }

    .btn-test:hover {
      background: #6d28d9;
    }

    .btn-delete {
      background: #dc2626;
      color: white;
    }

    .btn-delete:hover {
      background: #b91c1c;
    }

    /* 状态展示 */
    .status {
      padding: 16px 20px;
      background: #f0f9ff;
      border-left: 4px solid #0ea5e9;
      margin: 16px 20px;
      border-radius: 4px;
    }

    .status.success {
      background: #f0fdf4;
      border-color: #22c55e;
    }

    .status.error {
      background: #fef2f2;
      border-color: #ef4444;
    }

    /* 响应式 */
    @media (max-width: 768px) {
      .config-header {
        flex-direction: column;
      }
      
      .field-header {
        flex-direction: column;
      }
      
      .actions-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .action-btn {
        justify-content: center;
      }
    }

    /* 隐藏状态 */
    .hidden {
      display: none;
    }

    /* 加载状态 */
    .loading {
      pointer-events: none;
      opacity: 0.6;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-top: 2px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 标题区 -->
    <div class="header">
      🔄 飞书多维表格跨表复制工具
    </div>

    <!-- 基础配置区 -->
    <div class="config-section">
      <div class="config-header">
        <div class="config-item">
          <span class="config-label">源表复制记录</span>
          <div class="form-group">
            <input type="text" id="baseId" placeholder="BaseID (应用令牌)">
            <input type="text" id="sourceTableId" placeholder="源表ID">
            <input type="text" id="token" placeholder="PersonalBaseToken">
          </div>
        </div>
        <div class="config-item">
          <span class="config-label">目标表格</span>
          <div class="form-group">
            <input type="text" id="targetTableId" placeholder="目标表ID">
          </div>
        </div>
      </div>
    </div>

    <!-- 字段匹配区 -->
    <div class="field-section">
      <div class="field-header">
        <div class="field-item">
          <label>配置字段</label>
          <button id="loadFields" class="get-records-btn">加载字段信息</button>
        </div>
        <div class="field-item">
          <label>匹配值</label>
          <select id="fieldMapping">
            <option value="auto">自动匹配同名字段</option>
            <option value="manual">手动配置字段映射</option>
          </select>
        </div>
      </div>
      
      <!-- 字段映射详情 -->
      <div id="fieldMappingDetails" class="hidden">
        <div id="fieldMappingContainer"></div>
      </div>
    </div>

    <!-- 数据预览区 -->
    <div class="preview-section">
      <div class="preview-header">
        <button id="getRecords" class="get-records-btn">
          <span>📋</span> 获取左侧选中的所有记录
        </button>
        <div class="records-info">
          已选: <span id="selectedCount">0</span> 条数据
        </div>
      </div>

      <!-- 记录表格 -->
      <div id="recordsContainer" class="hidden">
        <table class="records-table">
          <thead>
            <tr>
              <th>
                <input type="checkbox" id="selectAll" class="record-checkbox">
              </th>
              <th>序号</th>
              <th>主要字段</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="recordsTable">
            <!-- 动态生成记录行 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 操作按钮区 -->
    <div class="actions-section">
      <button id="deleteSelected" class="action-btn btn-delete">
        <span>🗑️</span> 批量删除
      </button>
      <button id="copySelected" class="action-btn btn-copy-selected">
        <span>📋</span> 整行复制
      </button>
      <button id="copyAll" class="action-btn btn-copy-all">
        <span>📊</span> 整表复制
      </button>
      <button id="testCopy" class="action-btn btn-test">
        <span>🧪</span> 测试复制
      </button>
    </div>

    <!-- 状态显示区 -->
    <div id="status" class="status hidden">
      <div id="statusMessage"></div>
    </div>
  </div>

  <script>
    // 全局状态
    let sourceFields = [];
    let targetFields = [];
    let records = [];
    let selectedRecords = new Set();

    // DOM 元素
    const elements = {
      baseId: document.getElementById('baseId'),
      sourceTableId: document.getElementById('sourceTableId'),
      targetTableId: document.getElementById('targetTableId'),
      token: document.getElementById('token'),
      loadFields: document.getElementById('loadFields'),
      fieldMapping: document.getElementById('fieldMapping'),
      fieldMappingDetails: document.getElementById('fieldMappingDetails'),
      getRecords: document.getElementById('getRecords'),
      recordsContainer: document.getElementById('recordsContainer'),
      recordsTable: document.getElementById('recordsTable'),
      selectAll: document.getElementById('selectAll'),
      selectedCount: document.getElementById('selectedCount'),
      deleteSelected: document.getElementById('deleteSelected'),
      copySelected: document.getElementById('copySelected'),
      copyAll: document.getElementById('copyAll'),
      testCopy: document.getElementById('testCopy'),
      status: document.getElementById('status'),
      statusMessage: document.getElementById('statusMessage')
    };

    // 工具函数
    function showStatus(message, type = 'info') {
      elements.status.className = `status ${type}`;
      elements.statusMessage.textContent = message;
      elements.status.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          elements.status.classList.add('hidden');
        }, 3000);
      }
    }

    function setLoading(element, loading) {
      if (loading) {
        element.classList.add('loading');
        const spinner = document.createElement('span');
        spinner.className = 'spinner';
        element.appendChild(spinner);
      } else {
        element.classList.remove('loading');
        const spinner = element.querySelector('.spinner');
        if (spinner) spinner.remove();
      }
    }

    function getConfig() {
      return {
        baseId: elements.baseId.value.trim(),
        sourceTableId: elements.sourceTableId.value.trim(),
        targetTableId: elements.targetTableId.value.trim(),
        token: elements.token.value.trim()
      };
    }

    function validateConfig() {
      const config = getConfig();
      if (!config.baseId || !config.sourceTableId || !config.targetTableId || !config.token) {
        showStatus('请填写所有必填配置项', 'error');
        return false;
      }
      return true;
    }

    // 加载字段信息
    async function loadFields() {
      if (!validateConfig()) return;

      setLoading(elements.loadFields, true);
      try {
        const config = getConfig();
        const response = await fetch('/api/fields', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.success) {
          sourceFields = result.sourceFields;
          targetFields = result.targetFields;
          updateFieldMapping();
          showStatus(`加载成功: 源表 ${sourceFields.length} 个字段, 目标表 ${targetFields.length} 个字段`, 'success');
        } else {
          showStatus(`加载失败: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`请求失败: ${error.message}`, 'error');
      }
      setLoading(elements.loadFields, false);
    }

    // 更新字段映射
    function updateFieldMapping() {
      if (elements.fieldMapping.value === 'manual') {
        elements.fieldMappingDetails.classList.remove('hidden');
        renderFieldMapping();
      } else {
        elements.fieldMappingDetails.classList.add('hidden');
      }
    }

    // 渲染字段映射
    function renderFieldMapping() {
      const container = document.getElementById('fieldMappingContainer');
      container.innerHTML = '<h4>字段映射配置:</h4>';
      
      sourceFields.forEach(sourceField => {
        const row = document.createElement('div');
        row.style.cssText = 'display: flex; gap: 12px; margin-bottom: 8px; align-items: center;';
        
        row.innerHTML = `
          <span style="width: 150px; font-size: 14px;">${sourceField.name}</span>
          <span style="width: 20px; text-align: center;">→</span>
          <select style="flex: 1; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
            <option value="">不映射</option>
            ${targetFields.map(tf => 
              `<option value="${tf.id}" ${tf.name === sourceField.name ? 'selected' : ''}>${tf.name}</option>`
            ).join('')}
          </select>
        `;
        
        container.appendChild(row);
      });
    }

    // 获取记录数据
    async function getRecords() {
      if (!validateConfig()) return;

      setLoading(elements.getRecords, true);
      try {
        const config = getConfig();
        const response = await fetch('/api/get-records', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.success) {
          records = result.records;
          renderRecords();
          showStatus(`获取成功: ${records.length} 条记录`, 'success');
        } else {
          showStatus(`获取失败: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`请求失败: ${error.message}`, 'error');
      }
      setLoading(elements.getRecords, false);
    }

    // 渲染记录表格
    function renderRecords() {
      elements.recordsTable.innerHTML = '';
      elements.recordsContainer.classList.remove('hidden');
      
      records.forEach((record, index) => {
        const row = document.createElement('tr');
        const firstFieldValue = Object.values(record.fields)[0] || '无数据';
        
        row.innerHTML = `
          <td><input type="checkbox" class="record-checkbox" data-record-id="${record.record_id}"></td>
          <td>${index + 1}</td>
          <td>${firstFieldValue}</td>
          <td>
            <button onclick="viewRecord('${record.record_id}')" style="padding: 4px 8px; font-size: 12px; border: none; background: #e5e7eb; border-radius: 4px; cursor: pointer;">查看</button>
          </td>
        `;
        
        elements.recordsTable.appendChild(row);
      });

      // 绑定复选框事件
      bindCheckboxEvents();
    }

    // 绑定复选框事件
    function bindCheckboxEvents() {
      const checkboxes = document.querySelectorAll('.record-checkbox[data-record-id]');
      
      checkboxes.forEach(cb => {
        cb.addEventListener('change', (e) => {
          const recordId = e.target.dataset.recordId;
          if (e.target.checked) {
            selectedRecords.add(recordId);
          } else {
            selectedRecords.delete(recordId);
          }
          updateSelectedCount();
          updateSelectAllState();
        });
      });

      elements.selectAll.addEventListener('change', (e) => {
        checkboxes.forEach(cb => {
          cb.checked = e.target.checked;
          const recordId = cb.dataset.recordId;
          if (e.target.checked) {
            selectedRecords.add(recordId);
          } else {
            selectedRecords.delete(recordId);
          }
        });
        updateSelectedCount();
      });
    }

    // 更新选中计数
    function updateSelectedCount() {
      elements.selectedCount.textContent = selectedRecords.size;
    }

    // 更新全选状态
    function updateSelectAllState() {
      const checkboxes = document.querySelectorAll('.record-checkbox[data-record-id]');
      const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
      
      if (checkedCount === 0) {
        elements.selectAll.indeterminate = false;
        elements.selectAll.checked = false;
      } else if (checkedCount === checkboxes.length) {
        elements.selectAll.indeterminate = false;
        elements.selectAll.checked = true;
      } else {
        elements.selectAll.indeterminate = true;
      }
    }

    // 复制选中记录
    async function copySelected() {
      if (selectedRecords.size === 0) {
        showStatus('请先选择要复制的记录', 'error');
        return;
      }

      if (!validateConfig()) return;

      setLoading(elements.copySelected, true);
      try {
        const config = getConfig();
        const selectedRecordIds = Array.from(selectedRecords);
        
        const response = await fetch('/api/copy-selected', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...config,
            recordIds: selectedRecordIds,
            fieldMapping: elements.fieldMapping.value
          })
        });

        const result = await response.json();
        if (result.success) {
          showStatus(`复制成功: ${result.copiedCount} 条记录`, 'success');
          selectedRecords.clear();
          updateSelectedCount();
          // 重新获取记录刷新状态
          await getRecords();
        } else {
          showStatus(`复制失败: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`请求失败: ${error.message}`, 'error');
      }
      setLoading(elements.copySelected, false);
    }

    // 整表复制
    async function copyAll() {
      if (!validateConfig()) return;

      const confirmed = confirm('确定要复制整个表格的数据吗？这将覆盖目标表的现有数据。');
      if (!confirmed) return;

      setLoading(elements.copyAll, true);
      try {
        const config = getConfig();
        const response = await fetch('/api/copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.success) {
          showStatus(`整表复制成功: ${result.copiedCount} 条记录`, 'success');
        } else {
          showStatus(`复制失败: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`请求失败: ${error.message}`, 'error');
      }
      setLoading(elements.copyAll, false);
    }

    // 测试复制
    async function testCopy() {
      if (!validateConfig()) return;

      setLoading(elements.testCopy, true);
      try {
        const config = getConfig();
        const response = await fetch('/api/test-copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });

        const result = await response.json();
        if (result.success) {
          showStatus(`测试成功: 已复制 1 条记录`, 'success');
        } else {
          showStatus(`测试失败: ${result.error}`, 'error');
        }
      } catch (error) {
        showStatus(`请求失败: ${error.message}`, 'error');
      }
      setLoading(elements.testCopy, false);
    }

    // 删除选中记录
    async function deleteSelected() {
      if (selectedRecords.size === 0) {
        showStatus('请先选择要删除的记录', 'error');
        return;
      }

      const confirmed = confirm(`确定要删除选中的 ${selectedRecords.size} 条记录吗？`);
      if (!confirmed) return;

      showStatus('删除功能暂未实现', 'error');
    }

    // 查看记录详情
    function viewRecord(recordId) {
      const record = records.find(r => r.record_id === recordId);
      if (record) {
        alert(`记录详情:\n${JSON.stringify(record.fields, null, 2)}`);
      }
    }

    // 事件绑定
    elements.loadFields.addEventListener('click', loadFields);
    elements.fieldMapping.addEventListener('change', updateFieldMapping);
    elements.getRecords.addEventListener('click', getRecords);
    elements.copySelected.addEventListener('click', copySelected);
    elements.copyAll.addEventListener('click', copyAll);
    elements.testCopy.addEventListener('click', testCopy);
    elements.deleteSelected.addEventListener('click', deleteSelected);

    // 初始化
    showStatus('请填写配置信息并加载字段', 'info');
  </script>
</body>
</html>
