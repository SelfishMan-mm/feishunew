<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>飞书多维表格跨表复制</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 24px;
      background: #f5f7fa;
      color: #2c3e50;
      min-height: 100vh;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      overflow: visible;
    }

    .header {
      background: white;
      padding: 32px 32px 24px 32px;
      text-align: left;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      margin-bottom: 24px;
    }

    .title {
      font-size: 26px;
      font-weight: 600;
      color: #2c3e50;
      margin: 0 0 8px 0;
      line-height: 1.2;
    }

    .subtitle {
      font-size: 15px;
      color: #64748b;
      margin: 0;
    }

    .highlight {
      color: #1e40af;
      font-weight: 600;
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .table-selector {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .selector-label {
      font-size: 15px;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 12px;
      display: block;
    }

    .table-dropdown {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .table-dropdown:focus {
      outline: none;
      border-color: #1e40af;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .table-dropdown:hover {
      border-color: #3b82f6;
    }

    .compare-section {
      text-align: center;
      background: white;
      padding: 32px 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .compare-btn {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    }

    .compare-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
    }

    .compare-btn:active {
      transform: translateY(0);
    }

    .compare-text {
      color: #1e40af;
      font-size: 15px;
      font-weight: 500;
      margin-top: 16px;
    }

    .query-section {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .query-label {
      color: #1e40af;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      display: block;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .action-btn {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #1e40af;
      border-radius: 6px;
      background: white;
      color: #1e40af;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .action-btn:hover:not(:disabled) {
      background: #1e40af;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border-color: #1e40af;
    }

    .action-btn.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
    }

    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: #f8fafc;
      color: #94a3b8;
      border-color: #e2e8f0;
    }

    .hidden {
      display: none;
    }

    /* 数据预览表格 */
    .preview-section {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .preview-table th,
    .preview-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
    }

    .preview-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e40af;
      font-size: 14px;
      position: sticky;
      top: 0;
    }

    .preview-table td {
      font-size: 14px;
      color: #475569;
    }

    .preview-table tr:last-child td {
      border-bottom: none;
    }

    .preview-table tr:hover {
      background: #f8fafc;
    }

    .no-data {
      text-align: center;
      padding: 48px 20px;
      color: #94a3b8;
      font-style: italic;
    }

    .data-count {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 16px;
      font-weight: 500;
    }

    /* 操作日志 */
    .log-section {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .log-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 16px;
      display: block;
    }

    #log {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      padding: 20px;
      white-space: pre-wrap;
      font-family: 'SF Mono', 'Monaco', 'JetBrains Mono', 'Cascadia Code', monospace;
      max-height: 220px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.5;
      color: #475569;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    /* 隐藏的授权区域 */
    .auth-section {
      position: fixed;
      top: 16px;
      right: 16px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-width: 300px;
      border: 1px solid #e2e8f0;
    }

    .auth-section input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .auth-section input:focus {
      outline: none;
      border-color: #1e40af;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .auth-section button {
      width: 100%;
      padding: 12px 16px;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .auth-section button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
    }

    .auth-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
      transition: all 0.2s ease;
    }

    .auth-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
    }

    .row-checkbox {
      width: auto;
      margin-right: 8px;
      transform: scale(1.1);
      accent-color: #1e40af;
    }

    .selected-row {
      background: #eff6ff !important;
      border-left: 3px solid #1e40af;
    }

    /* 滚动条美化 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }

      .container {
        max-width: 100%;
      }

      .header {
        padding: 24px 20px 20px 20px;
      }

      .table-selector,
      .compare-section,
      .query-section,
      .action-buttons,
      .preview-section,
      .log-section {
        padding: 20px 16px;
      }
    }
  </style>
</head>

<body>
  <!-- 授权切换按钮 -->
  <button class="auth-toggle" onclick="toggleAuth()" id="authToggle">设置授权</button>

  <!-- 隐藏的授权区域 -->
  <div class="auth-section hidden" id="authSection">
    <input id="baseId" placeholder="Base ID (自动获取)" />
    <input id="personalToken" placeholder="PersonalBaseToken" type="password" />
    <button onclick="testAuth()">测试授权</button>
    <div style="font-size: 11px; color: #666; margin-top: 8px;" id="authStatus">未授权</div>
  </div>

  <div class="container">
    <div class="header">
      <div class="title">欢迎使用 跨表比对 <span class="highlight">跨表复制</span></div>
      <div class="subtitle">支持动态授权，通用于任意Base</div>
    </div>

    <div class="content">
      <!-- 主要选择区域 -->
      <div class="table-selector">
        <div class="selector-label">选择源数据表</div>
        <select class="table-dropdown" id="sourceTable" onchange="onSourceTableChange()">
          <option value="">请先完成授权后选择表格</option>
        </select>
      </div>

      <div class="table-selector">
        <div class="selector-label">选择目标数据表</div>
        <select class="table-dropdown" id="targetTable">
          <option value="">请先完成授权后选择表格</option>
        </select>
      </div>

      <div class="compare-section">
        <button class="compare-btn" onclick="loadPreviewData()">
          <span>对比</span>
        </button>
        <div class="compare-text">选择查询字段</div>
      </div>

      <!-- 查询字段选择 -->
      <div class="table-selector">
        <div class="selector-label">选择查询字段</div>
        <select class="table-dropdown" id="queryFieldSelect">
          <option value="">请先选择源表格</option>
        </select>
      </div>

      <div class="query-section">
        <div class="query-label">填写查询值</div>
        <div style="display: flex; gap: 10px;">
          <select class="table-dropdown" id="queryOperator" style="flex: 0 0 120px;">
            <option value="contains">包含</option>
            <option value="equals">等于</option>
            <option value="startsWith">开头是</option>
            <option value="endsWith">结尾是</option>
            <option value="notEmpty">不为空</option>
            <option value="isEmpty">为空</option>
          </select>
          <input type="text" class="table-dropdown" id="queryValue" placeholder="请输入要查询的值" style="flex: 1;" />
        </div>
      </div>

      <!-- 数据预览区域 -->
      <div class="preview-section" id="previewSection" style="display: none;">
        <div class="data-count" id="dataCount">已选：0 条数据</div>
        <table class="preview-table" id="previewTable">
          <thead>
            <tr>
              <th>选择</th>
              <th>序号</th>
              <th id="primaryFieldHeader">主字段</th>
            </tr>
          </thead>
          <tbody id="previewTableBody">
            <tr>
              <td colspan="3" class="no-data">请先选择表格并点击对比按钮</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 字段映射配置 -->
      <div class="preview-section" id="fieldMappingSection" style="display: none;">
        <div class="data-count">字段映射配置</div>
        <table class="preview-table" id="fieldMappingTable">
          <thead>
            <tr>
              <th>源字段</th>
              <th>目标字段</th>
            </tr>
          </thead>
          <tbody id="fieldMappingBody">
          </tbody>
        </table>
      </div>

      <!-- 操作按钮 -->
      <div class="action-buttons">
        <button class="action-btn" onclick="showFieldMapping()" id="configMappingBtn" disabled>配置字段映射</button>
        <button class="action-btn" onclick="copySelectedRows()" id="copyRowsBtn" disabled>整行复制</button>
        <button class="action-btn primary" onclick="copyEntireTable()" id="copyTableBtn" disabled>整表复制</button>
      </div>

      <!-- 操作日志 -->
      <div class="log-section">
        <div class="log-title">操作日志</div>
        <div id="log">请先设置授权信息...</div>
      </div>
    </div>
  </div>

  <script>
    let currentBaseId = null;
    let currentToken = null;
    let isAuthorized = false;
    let sourceTableData = [];
    let selectedRows = new Set();
    let sourceFields = [];
    let targetFields = [];
    let customFieldMapping = {};

    // 页面加载时初始化
    window.addEventListener('load', () => {
      autoDetectBaseId();
    });

    // 切换授权面板
    function toggleAuth() {
      const authSection = document.getElementById('authSection');
      const authToggle = document.getElementById('authToggle');

      if (authSection.classList.contains('hidden')) {
        authSection.classList.remove('hidden');
        authToggle.textContent = '隐藏授权';
      } else {
        authSection.classList.add('hidden');
        authToggle.textContent = '设置授权';
      }
    }

    // 自动从URL获取BaseId
    function autoDetectBaseId() {
      const currentUrl = window.location.href;
      const baseIdMatch = currentUrl.match(/\/base\/([a-zA-Z0-9]+)/);

      if (baseIdMatch) {
        currentBaseId = baseIdMatch[1];
        document.getElementById('baseId').value = currentBaseId;
        log(`✅ 自动获取BaseId: ${currentBaseId}`);
      } else {
        log('⚠️ 无法从URL自动获取BaseId，请手动输入');
        document.getElementById('baseId').placeholder = '请输入Base ID';
      }
    }

    // 测试授权
    async function testAuth() {
      const token = document.getElementById('personalToken').value.trim();
      const baseId = document.getElementById('baseId').value.trim();

      if (!token) {
        return log('❗ 请输入PersonalBaseToken');
      }

      if (!baseId) {
        return log('❗ 请输入Base ID');
      }

      log('🔍 正在测试授权...');

      try {
        const response = await fetch('/api/test-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId, personalToken: token })
        });

        const data = await response.json();
        if (data.success) {
          currentToken = token;
          currentBaseId = baseId;
          isAuthorized = true;

          document.getElementById('authStatus').textContent = '授权成功';
          document.getElementById('authStatus').style.color = '#52c41a';

          await loadTables();
          log(`✅ 授权成功！可访问 ${data.tableCount} 个表格`);
        } else {
          isAuthorized = false;
          document.getElementById('authStatus').textContent = '授权失败';
          document.getElementById('authStatus').style.color = '#ff4d4f';
          log(`❌ 授权失败: ${data.error}`);
        }
      } catch (error) {
        log(`❌ 测试授权失败: ${error.message}`);
      }
    }

    // 加载表格列表
    async function loadTables() {
      if (!isAuthorized) return;

      try {
        const response = await fetch('/api/tables', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId: currentBaseId, personalToken: currentToken })
        });

        const data = await response.json();
        if (data.success) {
          const sourceSelect = document.getElementById('sourceTable');
          const targetSelect = document.getElementById('targetTable');

          sourceSelect.innerHTML = '<option value="">请选择源数据表</option>';
          targetSelect.innerHTML = '<option value="">请选择目标数据表</option>';

          data.tables.forEach(table => {
            const sourceOption = document.createElement('option');
            sourceOption.value = table.table_id;
            sourceOption.textContent = table.name;
            sourceSelect.appendChild(sourceOption);

            const targetOption = document.createElement('option');
            targetOption.value = table.table_id;
            targetOption.textContent = table.name;
            targetSelect.appendChild(targetOption);
          });

          log(`✅ 已加载 ${data.tables.length} 个表格`);
        }
      } catch (error) {
        log(`❌ 加载表格失败: ${error.message}`);
      }
    }

    // 源表格变化时的处理
    async function onSourceTableChange() {
      const sourceTableId = document.getElementById('sourceTable').value;
      if (!sourceTableId) {
        document.getElementById('queryFieldSelect').innerHTML = '<option value="">请先选择源表格</option>';
        return;
      }

      // 重置预览数据
      document.getElementById('previewSection').style.display = 'none';
      document.getElementById('fieldMappingSection').style.display = 'none';
      selectedRows.clear();
      customFieldMapping = {};
      updateButtonStates();

      // 加载源表格字段到查询字段选择器
      await loadQueryFields(sourceTableId);

      log(`📋 已选择源表格: ${sourceTableId}`);
    }

    // 加载查询字段选项
    async function loadQueryFields(tableId) {
      try {
        const response = await fetch('/api/fields', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            baseId: currentBaseId,
            personalToken: currentToken,
            tableId: tableId
          })
        });

        const data = await response.json();
        if (data.success) {
          sourceFields = data.fields;
          const queryFieldSelect = document.getElementById('queryFieldSelect');
          queryFieldSelect.innerHTML = '<option value="">选择查询字段</option>';

          data.fields.forEach(field => {
            const option = document.createElement('option');
            option.value = field.field_id;
            option.textContent = `${field.field_name} (${field.type})`;
            queryFieldSelect.appendChild(option);
          });

          log(`✅ 已加载 ${data.fields.length} 个查询字段选项`);
        }
      } catch (error) {
        log(`❌ 加载查询字段失败: ${error.message}`);
      }
    }

    // 加载预览数据
    async function loadPreviewData() {
      const sourceTableId = document.getElementById('sourceTable').value;
      const targetTableId = document.getElementById('targetTable').value;
      const queryFieldId = document.getElementById('queryFieldSelect').value;
      const queryOperator = document.getElementById('queryOperator').value;
      const queryValue = document.getElementById('queryValue').value.trim();

      if (!sourceTableId) {
        return log('❗ 请先选择源数据表');
      }

      if (!targetTableId) {
        return log('❗ 请先选择目标数据表');
      }

      if (!isAuthorized) {
        return log('❗ 请先完成授权');
      }

      log('🔍 正在加载数据预览...');

      try {
        // 获取表格数据
        const dataResponse = await fetch('/api/data-operations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            operation: 'get-table-data',
            baseId: currentBaseId,
            personalToken: currentToken,
            tableId: sourceTableId
          })
        });

        const tableData = await dataResponse.json();
        if (!tableData.success) {
          throw new Error('获取表格数据失败');
        }

        sourceTableData = tableData.records;

        // 如果有查询条件，使用后端筛选逻辑
        let filteredData = sourceTableData;
        if (queryFieldId && queryValue && ['equals', 'contains', 'startsWith', 'endsWith'].includes(queryOperator)) {
          const filterResponse = await fetch('/api/data-operations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              operation: 'preview-filter',
              sourceTableId: sourceTableId,
              baseId: currentBaseId,
              personalToken: currentToken,
              filters: [{
                field: queryFieldId,
                operator: queryOperator,
                value: queryValue
              }]
            })
          });

          const filterResult = await filterResponse.json();
          if (filterResult.success) {
            // 重新获取筛选后的数据
            filteredData = sourceTableData.filter(record => {
              const fieldValue = record.fields[queryFieldId];
              return applyFilterLogic(fieldValue, queryOperator, queryValue);
            });
            log(`🔍 筛选结果：${filteredData.length} / ${sourceTableData.length} 条记录`);
          }
        } else if (queryFieldId && ['notEmpty', 'isEmpty'].includes(queryOperator)) {
          filteredData = sourceTableData.filter(record => {
            const fieldValue = record.fields[queryFieldId];
            return applyFilterLogic(fieldValue, queryOperator, '');
          });
          log(`🔍 筛选结果：${filteredData.length} / ${sourceTableData.length} 条记录`);
        }

        const queryFieldName = queryFieldId ?
          sourceFields.find(f => f.field_id === queryFieldId)?.field_name || '查询字段' :
          sourceFields[0]?.field_name || '主字段';

        displayPreviewData(filteredData, queryFieldName, queryFieldId);

        log(`✅ 已加载 ${sourceTableData.length} 条记录`);

      } catch (error) {
        log(`❌ 加载预览数据失败: ${error.message}`);
      }
    }

    // 前端筛选逻辑（与后端保持一致）
    function applyFilterLogic(fieldValue, operator, queryValue) {
      if (fieldValue === undefined || fieldValue === null || fieldValue === '') {
        return operator === 'isEmpty';
      }

      if (operator === 'notEmpty') {
        return true;
      }

      if (operator === 'isEmpty') {
        return false;
      }

      const valueStr = String(fieldValue).toLowerCase();
      const queryStr = String(queryValue).toLowerCase();

      switch (operator) {
        case 'equals':
          return valueStr === queryStr;
        case 'contains':
          return valueStr.includes(queryStr);
        case 'startsWith':
          return valueStr.startsWith(queryStr);
        case 'endsWith':
          return valueStr.endsWith(queryStr);
        default:
          return false;
      }
    }

    // 显示预览数据
    function displayPreviewData(records, fieldName, fieldId) {
      const previewSection = document.getElementById('previewSection');
      const dataCount = document.getElementById('dataCount');
      const primaryFieldHeader = document.getElementById('primaryFieldHeader');
      const tableBody = document.getElementById('previewTableBody');

      previewSection.style.display = 'block';
      primaryFieldHeader.textContent = fieldName;
      dataCount.textContent = `已选：${records.length} 条数据`;

      if (records.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="no-data">没有找到匹配的数据</td></tr>';
        updateButtonStates();
        return;
      }

      tableBody.innerHTML = records.map((record, index) => {
        const fieldValue = fieldId ? (record.fields[fieldId] || '无数据') : (record.fields[sourceFields[0]?.field_id] || '无数据');
        return `
          <tr>
            <td><input type="checkbox" class="row-checkbox" data-record-id="${record.record_id}" onchange="toggleRowSelection(this)"></td>
            <td>${index + 1}</td>
            <td>${fieldValue}</td>
          </tr>
        `;
      }).join('');

      updateButtonStates();
    }

    // 切换行选择
    function toggleRowSelection(checkbox) {
      const recordId = checkbox.dataset.recordId;
      const row = checkbox.closest('tr');

      if (checkbox.checked) {
        selectedRows.add(recordId);
        row.classList.add('selected-row');
      } else {
        selectedRows.delete(recordId);
        row.classList.remove('selected-row');
      }

      updateButtonStates();
    }

    // 显示字段映射配置
    async function showFieldMapping() {
      const sourceTableId = document.getElementById('sourceTable').value;
      const targetTableId = document.getElementById('targetTable').value;

      if (!sourceTableId || !targetTableId) {
        return log('❗ 请先选择源表格和目标表格');
      }

      try {
        // 获取目标表格字段
        const targetResponse = await fetch('/api/fields', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            baseId: currentBaseId,
            personalToken: currentToken,
            tableId: targetTableId
          })
        });

        const targetData = await targetResponse.json();
        if (!targetData.success) {
          throw new Error('获取目标表格字段失败');
        }

        targetFields = targetData.fields;
        displayFieldMappingTable();

        log(`✅ 字段映射配置已加载`);

      } catch (error) {
        log(`❌ 加载字段映射失败: ${error.message}`);
      }
    }

    // 显示字段映射表格
    function displayFieldMappingTable() {
      const fieldMappingSection = document.getElementById('fieldMappingSection');
      const fieldMappingBody = document.getElementById('fieldMappingBody');

      fieldMappingSection.style.display = 'block';

      // 自动建立初始映射
      const autoMapping = {};
      const targetFieldMap = new Map(targetFields.map(f => [f.field_name.toLowerCase(), f]));

      sourceFields.forEach(sourceField => {
        const matchedTarget = targetFieldMap.get(sourceField.field_name.toLowerCase());
        if (matchedTarget) {
          autoMapping[sourceField.field_id] = matchedTarget.field_id;
        }
      });

      customFieldMapping = { ...autoMapping };

      fieldMappingBody.innerHTML = sourceFields.map(sourceField => {
        const mappedTargetId = customFieldMapping[sourceField.field_id] || '';

        return `
          <tr>
            <td>${sourceField.field_name} (${sourceField.type})</td>
            <td>
              <select class="table-dropdown" data-source-field="${sourceField.field_id}" onchange="updateFieldMapping(this)">
                <option value="">-- 不映射 --</option>
                ${targetFields.map(tf =>
          `<option value="${tf.field_id}" ${tf.field_id === mappedTargetId ? 'selected' : ''}>${tf.field_name} (${tf.type})</option>`
        ).join('')}
              </select>
            </td>
          </tr>
        `;
      }).join('');

      log(`✅ 自动映射了 ${Object.keys(autoMapping).length} 个字段`);
    }

    // 更新字段映射
    function updateFieldMapping(selectElement) {
      const sourceFieldId = selectElement.dataset.sourceField;
      const targetFieldId = selectElement.value;

      if (targetFieldId) {
        customFieldMapping[sourceFieldId] = targetFieldId;
      } else {
        delete customFieldMapping[sourceFieldId];
      }

      log(`🔄 字段映射已更新，当前映射 ${Object.keys(customFieldMapping).length} 个字段`);
    }

    // 更新按钮状态
    function updateButtonStates() {
      const configMappingBtn = document.getElementById('configMappingBtn');
      const copyRowsBtn = document.getElementById('copyRowsBtn');
      const copyTableBtn = document.getElementById('copyTableBtn');

      const hasSourceData = sourceTableData.length > 0;
      const hasSelectedRows = selectedRows.size > 0;
      const hasTargetTable = document.getElementById('targetTable').value;
      const hasSourceTable = document.getElementById('sourceTable').value;

      configMappingBtn.disabled = !hasSourceTable || !hasTargetTable;
      copyRowsBtn.disabled = !hasSelectedRows || !hasTargetTable;
      copyTableBtn.disabled = !hasSourceData || !hasTargetTable;
    }

    // 整行复制
    async function copySelectedRows() {
      if (selectedRows.size === 0) {
        return log('❗ 请先选择要复制的行');
      }

      const targetTableId = document.getElementById('targetTable').value;
      if (!targetTableId) {
        return log('❗ 请先选择目标表格');
      }

      const selectedRecords = sourceTableData.filter(record => selectedRows.has(record.record_id));

      if (!confirm(`确定要复制选中的 ${selectedRecords.length} 条记录吗？`)) {
        return;
      }

      log(`🚀 开始复制选中的 ${selectedRecords.length} 条记录...`);

      try {
        const response = await fetch('/api/data-operations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            operation: 'copy-records',
            sourceTableId: document.getElementById('sourceTable').value,
            targetTableId: targetTableId,
            baseId: currentBaseId,
            personalToken: currentToken,
            records: selectedRecords,
            customFieldMapping: Object.keys(customFieldMapping).length > 0 ? customFieldMapping : null
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`✅ 整行复制完成！成功复制 ${data.copied} 条记录`);
          selectedRows.clear();
          // 重新加载预览数据以更新选择状态
          displayPreviewData(sourceTableData, document.getElementById('primaryFieldHeader').textContent);
        } else {
          log(`❌ 整行复制失败: ${data.error}`);
        }
      } catch (error) {
        log(`❌ 网络错误: ${error.message}`);
      }
    }

    // 整表复制
    async function copyEntireTable() {
      const sourceTableId = document.getElementById('sourceTable').value;
      const targetTableId = document.getElementById('targetTable').value;

      if (!sourceTableId || !targetTableId) {
        return log('❗ 请先选择源表格和目标表格');
      }

      if (!confirm(`确定要复制整个表格的所有数据吗？\n将复制 ${sourceTableData.length} 条记录`)) {
        return;
      }

      log(`🚀 开始整表复制，共 ${sourceTableData.length} 条记录...`);

      try {
        const response = await fetch('/api/copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceTableId: sourceTableId,
            targetTableId: targetTableId,
            baseId: currentBaseId,
            personalToken: currentToken,
            customFieldMapping: Object.keys(customFieldMapping).length > 0 ? customFieldMapping : null
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`✅ 整表复制完成！成功复制 ${data.copied} 条记录`);
        } else {
          log(`❌ 整表复制失败: ${data.error}`);
        }
      } catch (error) {
        log(`❌ 网络错误: ${error.message}`);
      }
    }

    // 日志函数
    function log(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }
  </script>
</body>

</html>