<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>é£ä¹¦å¤šç»´è¡¨æ ¼è·¨è¡¨å¤åˆ¶</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 24px;
      background: #f5f7fa;
      color: #2c3e50;
      min-height: 100vh;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      overflow: visible;
    }

    .header {
      background: white;
      padding: 32px 32px 24px 32px;
      text-align: left;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      margin-bottom: 24px;
    }

    .title {
      font-size: 26px;
      font-weight: 600;
      color: #2c3e50;
      margin: 0 0 8px 0;
      line-height: 1.2;
    }

    .subtitle {
      font-size: 15px;
      color: #64748b;
      margin: 0;
    }

    .highlight {
      color: #1e40af;
      font-weight: 600;
    }

    .content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .table-selector {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .selector-label {
      font-size: 15px;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 12px;
      display: block;
    }

    .table-dropdown {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
    }

    .table-dropdown:focus {
      outline: none;
      border-color: #1e40af;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .table-dropdown:hover {
      border-color: #3b82f6;
    }

    .compare-section {
      text-align: center;
      background: white;
      padding: 32px 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .compare-btn {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    }

    .compare-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
    }

    .compare-btn:active {
      transform: translateY(0);
    }

    .compare-text {
      color: #1e40af;
      font-size: 15px;
      font-weight: 500;
      margin-top: 16px;
    }

    .query-section {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .query-label {
      color: #1e40af;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      display: block;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .action-btn {
      width: 100%;
      padding: 16px 20px;
      border: 2px solid #1e40af;
      border-radius: 6px;
      background: white;
      color: #1e40af;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .action-btn:hover:not(:disabled) {
      background: #1e40af;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border-color: #1e40af;
    }

    .action-btn.primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
    }

    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      background: #f8fafc;
      color: #94a3b8;
      border-color: #e2e8f0;
    }

    .hidden {
      display: none;
    }

    /* æ•°æ®é¢„è§ˆè¡¨æ ¼ */
    .preview-section {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #e2e8f0;
    }

    .preview-table th,
    .preview-table td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid #f1f5f9;
    }

    .preview-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e40af;
      font-size: 14px;
      position: sticky;
      top: 0;
    }

    .preview-table td {
      font-size: 14px;
      color: #475569;
    }

    .preview-table tr:last-child td {
      border-bottom: none;
    }

    .preview-table tr:hover {
      background: #f8fafc;
    }

    .no-data {
      text-align: center;
      padding: 48px 20px;
      color: #94a3b8;
      font-style: italic;
    }

    .data-count {
      color: #64748b;
      font-size: 14px;
      margin-bottom: 16px;
      font-weight: 500;
    }

    /* æ“ä½œæ—¥å¿— */
    .log-section {
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
    }

    .log-title {
      font-size: 16px;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 16px;
      display: block;
    }

    #log {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      padding: 20px;
      white-space: pre-wrap;
      font-family: 'SF Mono', 'Monaco', 'JetBrains Mono', 'Cascadia Code', monospace;
      max-height: 220px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.5;
      color: #475569;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    /* éšè—çš„æˆæƒåŒºåŸŸ */
    .auth-section {
      position: fixed;
      top: 16px;
      right: 16px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      max-width: 300px;
      border: 1px solid #e2e8f0;
    }

    .auth-section input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .auth-section input:focus {
      outline: none;
      border-color: #1e40af;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .auth-section button {
      width: 100%;
      padding: 12px 16px;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .auth-section button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
    }

    .auth-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
      transition: all 0.2s ease;
    }

    .auth-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.3);
    }

    .row-checkbox {
      width: auto;
      margin-right: 8px;
      transform: scale(1.1);
      accent-color: #1e40af;
    }

    .selected-row {
      background: #eff6ff !important;
      border-left: 3px solid #1e40af;
    }

    /* æ»šåŠ¨æ¡ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 16px;
      }
      
      .container {
        max-width: 100%;
      }
      
      .header {
        padding: 24px 20px 20px 20px;
      }
      
      .table-selector,
      .compare-section,
      .query-section,
      .action-buttons,
      .preview-section,
      .log-section {
        padding: 20px 16px;
      }
    }
  </style>
</head>

<body>
  <!-- æˆæƒåˆ‡æ¢æŒ‰é’® -->
  <button class="auth-toggle" onclick="toggleAuth()" id="authToggle">è®¾ç½®æˆæƒ</button>

  <!-- éšè—çš„æˆæƒåŒºåŸŸ -->
  <div class="auth-section hidden" id="authSection">
    <input id="baseId" placeholder="Base ID (è‡ªåŠ¨è·å–)" />
    <input id="personalToken" placeholder="PersonalBaseToken" type="password" />
    <button onclick="testAuth()">æµ‹è¯•æˆæƒ</button>
    <div style="font-size: 11px; color: #666; margin-top: 8px;" id="authStatus">æœªæˆæƒ</div>
  </div>

  <div class="container">
    <div class="header">
      <div class="title">æ¬¢è¿ä½¿ç”¨ è·¨è¡¨æ¯”å¯¹ <span class="highlight">è·¨è¡¨å¤åˆ¶</span></div>
      <div class="subtitle">æ”¯æŒåŠ¨æ€æˆæƒï¼Œé€šç”¨äºä»»æ„Base</div>
    </div>

    <div class="content">
      <!-- ä¸»è¦é€‰æ‹©åŒºåŸŸ -->
      <div class="table-selector">
        <div class="selector-label">é€‰æ‹©æºæ•°æ®è¡¨</div>
        <select class="table-dropdown" id="sourceTable" onchange="onSourceTableChange()">
          <option value="">è¯·å…ˆå®Œæˆæˆæƒåé€‰æ‹©è¡¨æ ¼</option>
        </select>
      </div>

      <div class="table-selector">
        <div class="selector-label">é€‰æ‹©ç›®æ ‡æ•°æ®è¡¨</div>
        <select class="table-dropdown" id="targetTable">
          <option value="">è¯·å…ˆå®Œæˆæˆæƒåé€‰æ‹©è¡¨æ ¼</option>
        </select>
      </div>

      <div class="compare-section">
        <button class="compare-btn" onclick="loadPreviewData()">
          <span>å¯¹æ¯”</span>
        </button>
        <div class="compare-text">é€‰æ‹©æŸ¥è¯¢å­—æ®µ</div>
      </div>

      <div class="query-section">
        <div class="query-label">å¡«å†™æŸ¥è¯¢å€¼</div>
        <input type="text" class="table-dropdown" id="queryValue" placeholder="è¯·è¾“å…¥è¦æŸ¥è¯¢çš„å€¼ï¼ˆå¯é€‰ï¼‰" />
      </div>

      <!-- æ•°æ®é¢„è§ˆåŒºåŸŸ -->
      <div class="preview-section" id="previewSection" style="display: none;">
        <div class="data-count" id="dataCount">å·²é€‰ï¼š0 æ¡æ•°æ®</div>
        <table class="preview-table" id="previewTable">
          <thead>
            <tr>
              <th>é€‰æ‹©</th>
              <th>åºå·</th>
              <th id="primaryFieldHeader">ä¸»å­—æ®µ</th>
            </tr>
          </thead>
          <tbody id="previewTableBody">
            <tr>
              <td colspan="3" class="no-data">è¯·å…ˆé€‰æ‹©è¡¨æ ¼å¹¶ç‚¹å‡»å¯¹æ¯”æŒ‰é’®</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="action-buttons">
        <button class="action-btn" onclick="copySelectedRows()" id="copyRowsBtn" disabled>æ•´è¡Œå¤åˆ¶</button>
        <button class="action-btn primary" onclick="copyEntireTable()" id="copyTableBtn" disabled>æ•´è¡¨å¤åˆ¶</button>
      </div>

      <!-- æ“ä½œæ—¥å¿— -->
      <div class="log-section">
        <div class="log-title">æ“ä½œæ—¥å¿—</div>
        <div id="log">è¯·å…ˆè®¾ç½®æˆæƒä¿¡æ¯...</div>
      </div>
    </div>
  </div>

  <script>
    let currentBaseId = null;
    let currentToken = null;
    let isAuthorized = false;
    let sourceTableData = [];
    let selectedRows = new Set();
    let primaryFieldId = null;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('load', () => {
      autoDetectBaseId();
    });

    // åˆ‡æ¢æˆæƒé¢æ¿
    function toggleAuth() {
      const authSection = document.getElementById('authSection');
      const authToggle = document.getElementById('authToggle');
      
      if (authSection.classList.contains('hidden')) {
        authSection.classList.remove('hidden');
        authToggle.textContent = 'éšè—æˆæƒ';
      } else {
        authSection.classList.add('hidden');
        authToggle.textContent = 'è®¾ç½®æˆæƒ';
      }
    }

    // è‡ªåŠ¨ä»URLè·å–BaseId
    function autoDetectBaseId() {
      const currentUrl = window.location.href;
      const baseIdMatch = currentUrl.match(/\/base\/([a-zA-Z0-9]+)/);

      if (baseIdMatch) {
        currentBaseId = baseIdMatch[1];
        document.getElementById('baseId').value = currentBaseId;
        log(`âœ… è‡ªåŠ¨è·å–BaseId: ${currentBaseId}`);
      } else {
        log('âš ï¸ æ— æ³•ä»URLè‡ªåŠ¨è·å–BaseIdï¼Œè¯·æ‰‹åŠ¨è¾“å…¥');
        document.getElementById('baseId').placeholder = 'è¯·è¾“å…¥Base ID';
      }
    }

    // æµ‹è¯•æˆæƒ
    async function testAuth() {
      const token = document.getElementById('personalToken').value.trim();
      const baseId = document.getElementById('baseId').value.trim();

      if (!token) {
        return log('â— è¯·è¾“å…¥PersonalBaseToken');
      }

      if (!baseId) {
        return log('â— è¯·è¾“å…¥Base ID');
      }

      log('ğŸ” æ­£åœ¨æµ‹è¯•æˆæƒ...');

      try {
        const response = await fetch('/api/test-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId, personalToken: token })
        });

        const data = await response.json();
        if (data.success) {
          currentToken = token;
          currentBaseId = baseId;
          isAuthorized = true;
          
          document.getElementById('authStatus').textContent = 'æˆæƒæˆåŠŸ';
          document.getElementById('authStatus').style.color = '#52c41a';
          
          await loadTables();
          log(`âœ… æˆæƒæˆåŠŸï¼å¯è®¿é—® ${data.tableCount} ä¸ªè¡¨æ ¼`);
        } else {
          isAuthorized = false;
          document.getElementById('authStatus').textContent = 'æˆæƒå¤±è´¥';
          document.getElementById('authStatus').style.color = '#ff4d4f';
          log(`âŒ æˆæƒå¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ æµ‹è¯•æˆæƒå¤±è´¥: ${error.message}`);
      }
    }

    // åŠ è½½è¡¨æ ¼åˆ—è¡¨
    async function loadTables() {
      if (!isAuthorized) return;

      try {
        const response = await fetch('/api/tables', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId: currentBaseId, personalToken: currentToken })
        });

        const data = await response.json();
        if (data.success) {
          const sourceSelect = document.getElementById('sourceTable');
          const targetSelect = document.getElementById('targetTable');
          
          sourceSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æºæ•°æ®è¡¨</option>';
          targetSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç›®æ ‡æ•°æ®è¡¨</option>';
          
          data.tables.forEach(table => {
            const sourceOption = document.createElement('option');
            sourceOption.value = table.table_id;
            sourceOption.textContent = table.name;
            sourceSelect.appendChild(sourceOption);
            
            const targetOption = document.createElement('option');
            targetOption.value = table.table_id;
            targetOption.textContent = table.name;
            targetSelect.appendChild(targetOption);
          });
          
          log(`âœ… å·²åŠ è½½ ${data.tables.length} ä¸ªè¡¨æ ¼`);
        }
      } catch (error) {
        log(`âŒ åŠ è½½è¡¨æ ¼å¤±è´¥: ${error.message}`);
      }
    }

    // æºè¡¨æ ¼å˜åŒ–æ—¶çš„å¤„ç†
    async function onSourceTableChange() {
      const sourceTableId = document.getElementById('sourceTable').value;
      if (!sourceTableId) return;

      // é‡ç½®é¢„è§ˆæ•°æ®
      document.getElementById('previewSection').style.display = 'none';
      selectedRows.clear();
      updateButtonStates();
      
      log(`ğŸ“‹ å·²é€‰æ‹©æºè¡¨æ ¼: ${sourceTableId}`);
    }

    // åŠ è½½é¢„è§ˆæ•°æ®
    async function loadPreviewData() {
      const sourceTableId = document.getElementById('sourceTable').value;
      const targetTableId = document.getElementById('targetTable').value;

      if (!sourceTableId) {
        return log('â— è¯·å…ˆé€‰æ‹©æºæ•°æ®è¡¨');
      }

      if (!targetTableId) {
        return log('â— è¯·å…ˆé€‰æ‹©ç›®æ ‡æ•°æ®è¡¨');
      }

      if (!isAuthorized) {
        return log('â— è¯·å…ˆå®Œæˆæˆæƒ');
      }

      log('ğŸ” æ­£åœ¨åŠ è½½æ•°æ®é¢„è§ˆ...');

      try {
        // è·å–æºè¡¨æ ¼å­—æ®µä¿¡æ¯
        const fieldsResponse = await fetch('/api/fields', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            baseId: currentBaseId, 
            personalToken: currentToken,
            tableId: sourceTableId
          })
        });

        const fieldsData = await fieldsResponse.json();
        if (!fieldsData.success) {
          throw new Error('è·å–å­—æ®µä¿¡æ¯å¤±è´¥');
        }

        // é€‰æ‹©ä¸»å­—æ®µï¼ˆç¬¬ä¸€ä¸ªå­—æ®µï¼‰
        primaryFieldId = fieldsData.fields[0]?.field_id;
        const primaryFieldName = fieldsData.fields[0]?.field_name || 'ä¸»å­—æ®µ';

        // è·å–è¡¨æ ¼æ•°æ®
        const dataResponse = await fetch('/api/data-operations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            operation: 'get-table-data',
            baseId: currentBaseId, 
            personalToken: currentToken,
            tableId: sourceTableId
          })
        });

        const tableData = await dataResponse.json();
        if (!tableData.success) {
          throw new Error('è·å–è¡¨æ ¼æ•°æ®å¤±è´¥');
        }

        sourceTableData = tableData.records;
        displayPreviewData(sourceTableData, primaryFieldName);
        
        log(`âœ… å·²åŠ è½½ ${sourceTableData.length} æ¡è®°å½•`);

      } catch (error) {
        log(`âŒ åŠ è½½é¢„è§ˆæ•°æ®å¤±è´¥: ${error.message}`);
      }
    }

    // æ˜¾ç¤ºé¢„è§ˆæ•°æ®
    function displayPreviewData(records, primaryFieldName) {
      const queryValue = document.getElementById('queryValue').value.trim().toLowerCase();
      
      // ç­›é€‰æ•°æ®
      let filteredRecords = records;
      if (queryValue && primaryFieldId) {
        filteredRecords = records.filter(record => {
          const fieldValue = record.fields[primaryFieldId];
          return fieldValue && String(fieldValue).toLowerCase().includes(queryValue);
        });
      }

      const previewSection = document.getElementById('previewSection');
      const dataCount = document.getElementById('dataCount');
      const primaryFieldHeader = document.getElementById('primaryFieldHeader');
      const tableBody = document.getElementById('previewTableBody');

      previewSection.style.display = 'block';
      primaryFieldHeader.textContent = primaryFieldName;
      dataCount.textContent = `å·²é€‰ï¼š${filteredRecords.length} æ¡æ•°æ®`;

      if (filteredRecords.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="no-data">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®</td></tr>';
        return;
      }

      tableBody.innerHTML = filteredRecords.map((record, index) => {
        const primaryValue = record.fields[primaryFieldId] || 'æ— æ•°æ®';
        return `
          <tr>
            <td><input type="checkbox" class="row-checkbox" data-record-id="${record.record_id}" onchange="toggleRowSelection(this)"></td>
            <td>${index + 1}</td>
            <td>${primaryValue}</td>
          </tr>
        `;
      }).join('');

      updateButtonStates();
    }

    // åˆ‡æ¢è¡Œé€‰æ‹©
    function toggleRowSelection(checkbox) {
      const recordId = checkbox.dataset.recordId;
      const row = checkbox.closest('tr');
      
      if (checkbox.checked) {
        selectedRows.add(recordId);
        row.classList.add('selected-row');
      } else {
        selectedRows.delete(recordId);
        row.classList.remove('selected-row');
      }
      
      updateButtonStates();
    }

    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    function updateButtonStates() {
      const copyRowsBtn = document.getElementById('copyRowsBtn');
      const copyTableBtn = document.getElementById('copyTableBtn');
      
      const hasSourceData = sourceTableData.length > 0;
      const hasSelectedRows = selectedRows.size > 0;
      const hasTargetTable = document.getElementById('targetTable').value;
      
      copyRowsBtn.disabled = !hasSelectedRows || !hasTargetTable;
      copyTableBtn.disabled = !hasSourceData || !hasTargetTable;
    }

    // æ•´è¡Œå¤åˆ¶
    async function copySelectedRows() {
      if (selectedRows.size === 0) {
        return log('â— è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„è¡Œ');
      }

      const targetTableId = document.getElementById('targetTable').value;
      if (!targetTableId) {
        return log('â— è¯·å…ˆé€‰æ‹©ç›®æ ‡è¡¨æ ¼');
      }

      const selectedRecords = sourceTableData.filter(record => selectedRows.has(record.record_id));
      
      if (!confirm(`ç¡®å®šè¦å¤åˆ¶é€‰ä¸­çš„ ${selectedRecords.length} æ¡è®°å½•å—ï¼Ÿ`)) {
        return;
      }

      log(`ğŸš€ å¼€å§‹å¤åˆ¶é€‰ä¸­çš„ ${selectedRecords.length} æ¡è®°å½•...`);

      try {
        const response = await fetch('/api/data-operations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            operation: 'copy-records',
            sourceTableId: document.getElementById('sourceTable').value,
            targetTableId: targetTableId,
            baseId: currentBaseId,
            personalToken: currentToken,
            records: selectedRecords
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`âœ… æ•´è¡Œå¤åˆ¶å®Œæˆï¼æˆåŠŸå¤åˆ¶ ${data.copied} æ¡è®°å½•`);
          selectedRows.clear();
          // é‡æ–°åŠ è½½é¢„è§ˆæ•°æ®ä»¥æ›´æ–°é€‰æ‹©çŠ¶æ€
          displayPreviewData(sourceTableData, document.getElementById('primaryFieldHeader').textContent);
        } else {
          log(`âŒ æ•´è¡Œå¤åˆ¶å¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // æ•´è¡¨å¤åˆ¶
    async function copyEntireTable() {
      const sourceTableId = document.getElementById('sourceTable').value;
      const targetTableId = document.getElementById('targetTable').value;

      if (!sourceTableId || !targetTableId) {
        return log('â— è¯·å…ˆé€‰æ‹©æºè¡¨æ ¼å’Œç›®æ ‡è¡¨æ ¼');
      }

      if (!confirm(`ç¡®å®šè¦å¤åˆ¶æ•´ä¸ªè¡¨æ ¼çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ\nå°†å¤åˆ¶ ${sourceTableData.length} æ¡è®°å½•`)) {
        return;
      }

      log(`ğŸš€ å¼€å§‹æ•´è¡¨å¤åˆ¶ï¼Œå…± ${sourceTableData.length} æ¡è®°å½•...`);

      try {
        const response = await fetch('/api/copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceTableId: sourceTableId,
            targetTableId: targetTableId,
            baseId: currentBaseId,
            personalToken: currentToken
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`âœ… æ•´è¡¨å¤åˆ¶å®Œæˆï¼æˆåŠŸå¤åˆ¶ ${data.copied} æ¡è®°å½•`);
        } else {
          log(`âŒ æ•´è¡¨å¤åˆ¶å¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // æ—¥å¿—å‡½æ•°
    function log(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }
  </script>
</body>

</html>