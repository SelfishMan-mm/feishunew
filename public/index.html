<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>飞书多维表格跨表复制</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f8f9fa;
      color: #333;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .header {
      padding: 30px 30px 20px 30px;
      text-align: left;
    }

    .title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin: 0 0 8px 0;
    }

    .subtitle {
      font-size: 16px;
      color: #666;
      margin: 0;
    }

    .highlight {
      color: #ff4757;
      font-weight: 600;
    }

    .content {
      padding: 0 30px 30px 30px;
    }

    .table-selector {
      margin-bottom: 25px;
    }

    .selector-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      padding: 8px 12px;
      border: 2px solid #ff4757;
      border-radius: 6px;
      display: inline-block;
      background: white;
    }

    .table-dropdown {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      color: #333;
      cursor: pointer;
      position: relative;
    }

    .table-dropdown:focus {
      outline: none;
      border-color: #ff4757;
      box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
    }

    .compare-section {
      text-align: center;
      margin: 30px 0;
    }

    .compare-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .compare-btn:hover {
      background: #3367d6;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }

    .compare-btn:active {
      transform: translateY(0);
    }

    .compare-text {
      color: #ff4757;
      font-size: 16px;
      font-weight: 600;
      margin-top: 12px;
    }

    .query-section {
      margin: 25px 0;
    }

    .query-label {
      color: #ff4757;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 30px;
    }

    .action-btn {
      width: 100%;
      padding: 16px;
      border: 2px solid #ff4757;
      border-radius: 8px;
      background: white;
      color: #ff4757;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .action-btn:hover:not(:disabled) {
      background: #ff4757;
      color: white;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 71, 87, 0.2);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn.primary {
      background: #ff4757;
      color: white;
    }

    .action-btn.primary:hover:not(:disabled) {
      background: #ff3742;
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .hidden {
      display: none;
    }

    /* 数据预览表格 */
    .preview-section {
      margin: 25px 0;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .preview-table th,
    .preview-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    .preview-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
      font-size: 13px;
    }

    .preview-table td {
      font-size: 14px;
      color: #666;
    }

    .preview-table tr:last-child td {
      border-bottom: none;
    }

    .preview-table tr:hover {
      background: #f8f9fa;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #999;
      font-style: italic;
    }

    .data-count {
      color: #666;
      font-size: 14px;
      margin-bottom: 12px;
    }

    /* 操作日志 */
    .log-section {
      margin-top: 30px;
    }

    .log-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
    }

    #log {
      background: #f8f9fa;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 16px;
      white-space: pre-wrap;
      font-family: 'SF Mono', Monaco, monospace;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
      line-height: 1.4;
      color: #666;
    }

    /* 隐藏的授权区域 */
    .auth-section {
      position: fixed;
      top: 10px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      max-width: 300px;
    }

    .auth-section input {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }

    .auth-section button {
      width: 100%;
      padding: 8px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .auth-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #4285f4;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      z-index: 1001;
    }

    .row-checkbox {
      width: auto;
      margin-right: 8px;
    }

    .selected-row {
      background: #e6f7ff !important;
    }
  </style>
</head>

<body>
  <!-- 授权切换按钮 -->
  <button class="auth-toggle" onclick="toggleAuth()" id="authToggle">设置授权</button>

  <!-- 隐藏的授权区域 -->
  <div class="auth-section hidden" id="authSection">
    <input id="baseId" placeholder="Base ID (自动获取)" />
    <input id="personalToken" placeholder="PersonalBaseToken" type="password" />
    <button onclick="testAuth()">测试授权</button>
    <div style="font-size: 11px; color: #666; margin-top: 8px;" id="authStatus">未授权</div>
  </div>

  <div class="container">
    <div class="header">
      <div class="title">欢迎使用 跨表比对 <span class="highlight">跨表复制</span></div>
      <div class="subtitle">支持动态授权，通用于任意Base</div>
    </div>

    <div class="content">
      <!-- 主要选择区域 -->
      <div class="table-selector">
        <div class="selector-label">选择源数据表</div>
        <select class="table-dropdown" id="sourceTable" onchange="onSourceTableChange()">
          <option value="">请先完成授权后选择表格</option>
        </select>
      </div>

      <div class="table-selector">
        <div class="selector-label">选择目标数据表</div>
        <select class="table-dropdown" id="targetTable">
          <option value="">请先完成授权后选择表格</option>
        </select>
      </div>

      <div class="compare-section">
        <button class="compare-btn" onclick="loadPreviewData()">
          <span>对比</span>
        </button>
        <div class="compare-text">选择查询字段</div>
      </div>

      <div class="query-section">
        <div class="query-label">填写查询值</div>
        <input type="text" class="table-dropdown" id="queryValue" placeholder="请输入要查询的值（可选）" />
      </div>

      <!-- 数据预览区域 -->
      <div class="preview-section" id="previewSection" style="display: none;">
        <div class="data-count" id="dataCount">已选：0 条数据</div>
        <table class="preview-table" id="previewTable">
          <thead>
            <tr>
              <th>选择</th>
              <th>序号</th>
              <th id="primaryFieldHeader">主字段</th>
            </tr>
          </thead>
          <tbody id="previewTableBody">
            <tr>
              <td colspan="3" class="no-data">请先选择表格并点击对比按钮</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- 操作按钮 -->
      <div class="action-buttons">
        <button class="action-btn" onclick="copySelectedRows()" id="copyRowsBtn" disabled>整行复制</button>
        <button class="action-btn primary" onclick="copyEntireTable()" id="copyTableBtn" disabled>整表复制</button>
      </div>

      <!-- 操作日志 -->
      <div class="log-section">
        <div class="log-title">操作日志</div>
        <div id="log">请先设置授权信息...</div>
      </div>
    </div>
  </div>

  <script>
    let currentBaseId = null;
    let currentToken = null;
    let isAuthorized = false;
    let sourceTableData = [];
    let selectedRows = new Set();
    let primaryFieldId = null;

    // 页面加载时初始化
    window.addEventListener('load', () => {
      autoDetectBaseId();
    });

    // 切换授权面板
    function toggleAuth() {
      const authSection = document.getElementById('authSection');
      const authToggle = document.getElementById('authToggle');
      
      if (authSection.classList.contains('hidden')) {
        authSection.classList.remove('hidden');
        authToggle.textContent = '隐藏授权';
      } else {
        authSection.classList.add('hidden');
        authToggle.textContent = '设置授权';
      }
    }

    // 自动从URL获取BaseId
    function autoDetectBaseId() {
      const currentUrl = window.location.href;
      const baseIdMatch = currentUrl.match(/\/base\/([a-zA-Z0-9]+)/);

      if (baseIdMatch) {
        currentBaseId = baseIdMatch[1];
        document.getElementById('baseId').value = currentBaseId;
        log(`✅ 自动获取BaseId: ${currentBaseId}`);
      } else {
        log('⚠️ 无法从URL自动获取BaseId，请手动输入');
        document.getElementById('baseId').placeholder = '请输入Base ID';
      }
    }

    // 测试授权
    async function testAuth() {
      const token = document.getElementById('personalToken').value.trim();
      const baseId = document.getElementById('baseId').value.trim();

      if (!token) {
        return log('❗ 请输入PersonalBaseToken');
      }

      if (!baseId) {
        return log('❗ 请输入Base ID');
      }

      log('🔍 正在测试授权...');

      try {
        const response = await fetch('/api/test-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId, personalToken: token })
        });

        const data = await response.json();
        if (data.success) {
          currentToken = token;
          currentBaseId = baseId;
          isAuthorized = true;
          
          document.getElementById('authStatus').textContent = '授权成功';
          document.getElementById('authStatus').style.color = '#52c41a';
          
          await loadTables();
          log(`✅ 授权成功！可访问 ${data.tableCount} 个表格`);
        } else {
          isAuthorized = false;
          document.getElementById('authStatus').textContent = '授权失败';
          document.getElementById('authStatus').style.color = '#ff4d4f';
          log(`❌ 授权失败: ${data.error}`);
        }
      } catch (error) {
        log(`❌ 测试授权失败: ${error.message}`);
      }
    }

    // 加载表格列表
    async function loadTables() {
      if (!isAuthorized) return;

      try {
        const response = await fetch('/api/tables', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId: currentBaseId, personalToken: currentToken })
        });

        const data = await response.json();
        if (data.success) {
          const sourceSelect = document.getElementById('sourceTable');
          const targetSelect = document.getElementById('targetTable');
          
          sourceSelect.innerHTML = '<option value="">请选择源数据表</option>';
          targetSelect.innerHTML = '<option value="">请选择目标数据表</option>';
          
          data.tables.forEach(table => {
            const sourceOption = document.createElement('option');
            sourceOption.value = table.table_id;
            sourceOption.textContent = table.name;
            sourceSelect.appendChild(sourceOption);
            
            const targetOption = document.createElement('option');
            targetOption.value = table.table_id;
            targetOption.textContent = table.name;
            targetSelect.appendChild(targetOption);
          });
          
          log(`✅ 已加载 ${data.tables.length} 个表格`);
        }
      } catch (error) {
        log(`❌ 加载表格失败: ${error.message}`);
      }
    }

    // 源表格变化时的处理
    async function onSourceTableChange() {
      const sourceTableId = document.getElementById('sourceTable').value;
      if (!sourceTableId) return;

      // 重置预览数据
      document.getElementById('previewSection').style.display = 'none';
      selectedRows.clear();
      updateButtonStates();
      
      log(`📋 已选择源表格: ${sourceTableId}`);
    }

    // 加载预览数据
    async function loadPreviewData() {
      const sourceTableId = document.getElementById('sourceTable').value;
      const targetTableId = document.getElementById('targetTable').value;

      if (!sourceTableId) {
        return log('❗ 请先选择源数据表');
      }

      if (!targetTableId) {
        return log('❗ 请先选择目标数据表');
      }

      if (!isAuthorized) {
        return log('❗ 请先完成授权');
      }

      log('🔍 正在加载数据预览...');

      try {
        // 获取源表格字段信息
        const fieldsResponse = await fetch('/api/fields', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            baseId: currentBaseId, 
            personalToken: currentToken,
            tableId: sourceTableId
          })
        });

        const fieldsData = await fieldsResponse.json();
        if (!fieldsData.success) {
          throw new Error('获取字段信息失败');
        }

        // 选择主字段（第一个字段）
        primaryFieldId = fieldsData.fields[0]?.field_id;
        const primaryFieldName = fieldsData.fields[0]?.field_name || '主字段';

        // 获取表格数据
        const dataResponse = await fetch('/api/data-operations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            operation: 'get-table-data',
            baseId: currentBaseId, 
            personalToken: currentToken,
            tableId: sourceTableId
          })
        });

        const tableData = await dataResponse.json();
        if (!tableData.success) {
          throw new Error('获取表格数据失败');
        }

        sourceTableData = tableData.records;
        displayPreviewData(sourceTableData, primaryFieldName);
        
        log(`✅ 已加载 ${sourceTableData.length} 条记录`);

      } catch (error) {
        log(`❌ 加载预览数据失败: ${error.message}`);
      }
    }

    // 显示预览数据
    function displayPreviewData(records, primaryFieldName) {
      const queryValue = document.getElementById('queryValue').value.trim().toLowerCase();
      
      // 筛选数据
      let filteredRecords = records;
      if (queryValue && primaryFieldId) {
        filteredRecords = records.filter(record => {
          const fieldValue = record.fields[primaryFieldId];
          return fieldValue && String(fieldValue).toLowerCase().includes(queryValue);
        });
      }

      const previewSection = document.getElementById('previewSection');
      const dataCount = document.getElementById('dataCount');
      const primaryFieldHeader = document.getElementById('primaryFieldHeader');
      const tableBody = document.getElementById('previewTableBody');

      previewSection.style.display = 'block';
      primaryFieldHeader.textContent = primaryFieldName;
      dataCount.textContent = `已选：${filteredRecords.length} 条数据`;

      if (filteredRecords.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="3" class="no-data">没有找到匹配的数据</td></tr>';
        return;
      }

      tableBody.innerHTML = filteredRecords.map((record, index) => {
        const primaryValue = record.fields[primaryFieldId] || '无数据';
        return `
          <tr>
            <td><input type="checkbox" class="row-checkbox" data-record-id="${record.record_id}" onchange="toggleRowSelection(this)"></td>
            <td>${index + 1}</td>
            <td>${primaryValue}</td>
          </tr>
        `;
      }).join('');

      updateButtonStates();
    }

    // 切换行选择
    function toggleRowSelection(checkbox) {
      const recordId = checkbox.dataset.recordId;
      const row = checkbox.closest('tr');
      
      if (checkbox.checked) {
        selectedRows.add(recordId);
        row.classList.add('selected-row');
      } else {
        selectedRows.delete(recordId);
        row.classList.remove('selected-row');
      }
      
      updateButtonStates();
    }

    // 更新按钮状态
    function updateButtonStates() {
      const copyRowsBtn = document.getElementById('copyRowsBtn');
      const copyTableBtn = document.getElementById('copyTableBtn');
      
      const hasSourceData = sourceTableData.length > 0;
      const hasSelectedRows = selectedRows.size > 0;
      const hasTargetTable = document.getElementById('targetTable').value;
      
      copyRowsBtn.disabled = !hasSelectedRows || !hasTargetTable;
      copyTableBtn.disabled = !hasSourceData || !hasTargetTable;
    }

    // 整行复制
    async function copySelectedRows() {
      if (selectedRows.size === 0) {
        return log('❗ 请先选择要复制的行');
      }

      const targetTableId = document.getElementById('targetTable').value;
      if (!targetTableId) {
        return log('❗ 请先选择目标表格');
      }

      const selectedRecords = sourceTableData.filter(record => selectedRows.has(record.record_id));
      
      if (!confirm(`确定要复制选中的 ${selectedRecords.length} 条记录吗？`)) {
        return;
      }

      log(`🚀 开始复制选中的 ${selectedRecords.length} 条记录...`);

      try {
        const response = await fetch('/api/data-operations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            operation: 'copy-records',
            sourceTableId: document.getElementById('sourceTable').value,
            targetTableId: targetTableId,
            baseId: currentBaseId,
            personalToken: currentToken,
            records: selectedRecords
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`✅ 整行复制完成！成功复制 ${data.copied} 条记录`);
          selectedRows.clear();
          // 重新加载预览数据以更新选择状态
          displayPreviewData(sourceTableData, document.getElementById('primaryFieldHeader').textContent);
        } else {
          log(`❌ 整行复制失败: ${data.error}`);
        }
      } catch (error) {
        log(`❌ 网络错误: ${error.message}`);
      }
    }

    // 整表复制
    async function copyEntireTable() {
      const sourceTableId = document.getElementById('sourceTable').value;
      const targetTableId = document.getElementById('targetTable').value;

      if (!sourceTableId || !targetTableId) {
        return log('❗ 请先选择源表格和目标表格');
      }

      if (!confirm(`确定要复制整个表格的所有数据吗？\n将复制 ${sourceTableData.length} 条记录`)) {
        return;
      }

      log(`🚀 开始整表复制，共 ${sourceTableData.length} 条记录...`);

      try {
        const response = await fetch('/api/copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceTableId: sourceTableId,
            targetTableId: targetTableId,
            baseId: currentBaseId,
            personalToken: currentToken
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`✅ 整表复制完成！成功复制 ${data.copied} 条记录`);
        } else {
          log(`❌ 整表复制失败: ${data.error}`);
        }
      } catch (error) {
        log(`❌ 网络错误: ${error.message}`);
      }
    }

    // 日志函数
    function log(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }
  </script>
</body>

</html>