<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>é£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®å¤åˆ¶å·¥å…·</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header {
      background: #4285f4;
      color: white;
      padding: 20px;
      border-radius: 8px 8px 0 0;
    }

    .content {
      padding: 20px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h3 {
      color: #333;
      border-bottom: 2px solid #4285f4;
      padding-bottom: 5px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    .form-row {
      display: flex;
      gap: 15px;
      align-items: end;
    }

    .form-row>div {
      flex: 1;
    }

    input,
    select,
    button {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 5px rgba(66, 133, 244, 0.3);
    }

    button {
      background: #4285f4;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #3367d6;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #log {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
    }

    small {
      color: #666;
      font-size: 0.9em;
    }

    /* å·®å¼‚ç»“æœæ ·å¼ */
    .diff-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    .diff-item {
      padding: 12px;
      border-radius: 6px;
      text-align: center;
      font-size: 13px;
      border: 1px solid;
    }

    .diff-new {
      background: #f6ffed;
      border-color: #b7eb8f;
      color: #389e0d;
    }

    .diff-deleted {
      background: #fff2f0;
      border-color: #ffccc7;
      color: #cf1322;
    }

    .diff-modified {
      background: #fffbe6;
      border-color: #ffe58f;
      color: #d48806;
    }

    .diff-same {
      background: #f0f7ff;
      border-color: #91d5ff;
      color: #1890ff;
    }

    .diff-count {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    /* å­—æ®µæ˜ å°„æ ·å¼ */
    #fieldMappingContainer {
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }

    .mapping-header {
      display: grid;
      grid-template-columns: 1fr 1fr;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }

    .source-header, .target-header {
      padding: 12px;
      font-weight: bold;
      text-align: center;
      border-right: 1px solid #ddd;
    }

    .target-header {
      border-right: none;
    }

    .mapping-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-bottom: 1px solid #eee;
      min-height: 50px;
      align-items: center;
    }

    .mapping-row:last-child {
      border-bottom: none;
    }

    .source-field, .target-field {
      padding: 12px;
      border-right: 1px solid #eee;
      display: flex;
      align-items: center;
    }

    .target-field {
      border-right: none;
    }

    .field-info {
      flex: 1;
    }

    .field-name {
      font-weight: 500;
      color: #333;
    }

    .field-type {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .mapping-select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }

    .mapping-status {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      margin-left: 8px;
    }

    .status-mapped {
      background: #f6ffed;
      color: #389e0d;
      border: 1px solid #b7eb8f;
    }

    .status-unmapped {
      background: #fff2f0;
      color: #cf1322;
      border: 1px solid #ffccc7;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>é£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®å¤åˆ¶å·¥å…·</h1>
      <p>æ”¯æŒåŠ¨æ€æˆæƒï¼Œé€šç”¨äºä»»æ„Base</p>
    </div>

    <div class="content">
      <!-- æˆæƒé…ç½® -->
      <div class="section">
        <h3>ğŸ” æˆæƒé…ç½®</h3>
        <div class="form-group">
          <label>Base IDï¼ˆè‡ªåŠ¨è·å–ï¼‰</label>
          <input id="baseId" placeholder="è‡ªåŠ¨ä»URLè·å–..." readonly />
        </div>
        <div class="form-group">
          <label>PersonalBaseTokenï¼ˆå¿…å¡«ï¼‰</label>
          <input id="personalToken" placeholder="è¯·è¾“å…¥æ­¤Baseçš„PersonalBaseToken" type="password" />
          <small>ğŸ’¡ æ¯ä¸ªBaseéƒ½æœ‰ç‹¬ç«‹çš„æˆæƒç ï¼Œè¯·åœ¨å¤šç»´è¡¨æ ¼è®¾ç½®ä¸­è·å–</small>
        </div>
        <div class="form-row">
          <button onclick="testAuth()">ğŸ” æµ‹è¯•æˆæƒ</button>
        </div>
      </div>

      <!-- è¡¨æ ¼é€‰æ‹© -->
      <div class="section" id="tableSection" style="display:none;">
        <h3>ğŸ“‹ è¡¨æ ¼é€‰æ‹©</h3>
        <div class="form-row">
          <div>
            <label>æºè¡¨æ ¼ID</label>
            <input id="sourceTable" placeholder="è¾“å…¥è¡¨æ ¼ID (tblXXXXXX)" />
            <button type="button" onclick="showTableSelector('source')">ğŸ“‹ é€‰æ‹©è¡¨æ ¼</button>
          </div>
          <div>
            <label>ç›®æ ‡è¡¨æ ¼ID</label>
            <input id="targetTable" placeholder="è¾“å…¥è¡¨æ ¼ID (tblYYYYYY)" />
            <button type="button" onclick="showTableSelector('target')">ğŸ“‹ é€‰æ‹©è¡¨æ ¼</button>
          </div>
        </div>
        <div class="form-group">
          <label>ä¸»é”®å­—æ®µï¼ˆç”¨äºå·®å¼‚å¯¹æ¯”ï¼‰</label>
          <select id="primaryKeyField">
            <option value="">è‡ªåŠ¨æ£€æµ‹</option>
          </select>
          <small>ğŸ’¡ é€‰æ‹©ç”¨äºåŒ¹é…è®°å½•çš„ä¸»é”®å­—æ®µï¼Œå¦‚IDã€ç¼–å·ç­‰</small>
        </div>
      </div>

      <!-- æ“ä½œæ¨¡å¼é€‰æ‹© -->
      <div class="section" id="operationSection" style="display:none;">
        <h3>âš™ï¸ æ“ä½œæ¨¡å¼</h3>
        <div class="form-group">
          <label style="display: flex; align-items: center; margin-bottom: 10px;">
            <input type="radio" name="operationMode" value="preview" checked style="margin-right: 8px; width: auto;">
            ğŸ” é¢„è§ˆå·®å¼‚ï¼ˆæ¨èï¼‰
          </label>
          <small style="margin-left: 24px; margin-bottom: 15px;">å…ˆåˆ†æå·®å¼‚ï¼Œå†å†³å®šæ˜¯å¦æ‰§è¡Œå¤åˆ¶</small>
          
          <label style="display: flex; align-items: center; margin-bottom: 10px;">
            <input type="radio" name="operationMode" value="direct" style="margin-right: 8px; width: auto;">
            ğŸš€ ç›´æ¥å¤åˆ¶
          </label>
          <small style="margin-left: 24px; margin-bottom: 15px;">è·³è¿‡åˆ†æç›´æ¥æ‰§è¡Œå¤åˆ¶</small>
          
          <label style="display: flex; align-items: center; margin-bottom: 10px;">
            <input type="radio" name="operationMode" value="mapping" style="margin-right: 8px; width: auto;">
            ğŸ¯ å­—æ®µæ˜ å°„
          </label>
          <small style="margin-left: 24px;">æ‰‹åŠ¨é…ç½®å­—æ®µå¯¹åº”å…³ç³»</small>
        </div>
        <div class="form-row">
          <button onclick="executeOperation()" id="operationBtn">ğŸ” å¼€å§‹åˆ†æ</button>
        </div>
      </div>

      <!-- å·®å¼‚ç»“æœæ˜¾ç¤º -->
      <div class="section" id="diffResultSection" style="display:none;">
        <h3>ğŸ“Š å·®å¼‚åˆ†æç»“æœ</h3>
        <div id="diffSummary"></div>
        <div class="form-row" style="gap: 10px;">
          <button onclick="executeCopy()" id="executeCopyBtn" style="background: #52c41a;">âœ… ç¡®è®¤æ‰§è¡Œå¤åˆ¶</button>
          <button onclick="exportResults()" id="exportBtn" style="background: #1890ff; flex: 0 0 auto;">ğŸ“„ å¯¼å‡ºç»“æœ</button>
        </div>
      </div>

      <!-- å­—æ®µæ˜ å°„ç•Œé¢ -->
      <div class="section" id="fieldMappingSection" style="display:none;">
        <h3>ğŸ¯ å­—æ®µæ˜ å°„é…ç½®</h3>
        <div id="fieldMappingContainer">
          <div class="mapping-header">
            <div class="source-header">æºè¡¨æ ¼å­—æ®µ</div>
            <div class="target-header">ç›®æ ‡è¡¨æ ¼å­—æ®µ</div>
          </div>
          <div id="fieldMappingList"></div>
        </div>
        <div class="form-row" style="margin-top: 20px;">
          <button onclick="executeWithMapping()" id="executeMappingBtn">ğŸš€ ä½¿ç”¨æ˜ å°„æ‰§è¡Œå¤åˆ¶</button>
        </div>
      </div>

      <!-- æ—¥å¿— -->
      <div class="section">
        <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
        <pre id="log">ç­‰å¾…æ“ä½œ...</pre>
      </div>
    </div>
  </div>

  <script>
    let currentBaseId = null;
    let currentToken = null;

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–BaseId
    window.addEventListener('load', () => {
      autoDetectBaseId();
    });

    // è‡ªåŠ¨ä»URLè·å–BaseId
    function autoDetectBaseId() {
      const currentUrl = window.location.href;
      const baseIdMatch = currentUrl.match(/\/base\/([a-zA-Z0-9]+)/);

      if (baseIdMatch) {
        currentBaseId = baseIdMatch[1];
        document.getElementById('baseId').value = currentBaseId;
        log(`âœ… è‡ªåŠ¨è·å–BaseId: ${currentBaseId}`);
      } else {
        // å¦‚æœæ— æ³•è‡ªåŠ¨è·å–ï¼Œä½¿ç”¨é»˜è®¤å€¼
        currentBaseId = 'KnX9bIOTKaE3trspPCycfFMjnkg';
        document.getElementById('baseId').value = currentBaseId + ' (é»˜è®¤)';
        log('âš ï¸ æ— æ³•è‡ªåŠ¨è·å–BaseIdï¼Œä½¿ç”¨é»˜è®¤å€¼');
      }
    }

    // æµ‹è¯•æˆæƒ
    async function testAuth() {
      const token = document.getElementById('personalToken').value.trim();
      const baseId = document.getElementById('baseId').value.replace(' (é»˜è®¤)', '').trim();

      if (!token) {
        return log('â— è¯·è¾“å…¥PersonalBaseToken');
      }

      if (!baseId) {
        return log('â— BaseIdä¸èƒ½ä¸ºç©º');
      }

      log('ğŸ” æ­£åœ¨æµ‹è¯•æˆæƒ...');

      try {
        const response = await fetch('/api/test-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId, personalToken: token })
        });

        const data = await response.json();
        if (data.success) {
          currentToken = token;
          currentBaseId = baseId;
          document.getElementById('tableSection').style.display = 'block';
          document.getElementById('operationSection').style.display = 'block';
          log(`âœ… æˆæƒæˆåŠŸï¼å¯è®¿é—® ${data.tableCount} ä¸ªè¡¨æ ¼`);
        } else {
          log(`âŒ æˆæƒå¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ æµ‹è¯•æˆæƒå¤±è´¥: ${error.message}`);
      }
    }

    // æ˜¾ç¤ºè¡¨æ ¼é€‰æ‹©å™¨
    async function showTableSelector(type) {
      if (!currentToken || !currentBaseId) {
        return log('â— è¯·å…ˆå®Œæˆæˆæƒæµ‹è¯•');
      }

      log('ğŸ“‹ æ­£åœ¨è·å–è¡¨æ ¼åˆ—è¡¨...');

      try {
        const response = await fetch('/api/tables', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId: currentBaseId, personalToken: currentToken })
        });

        const data = await response.json();
        if (data.success) {
          const tables = data.tables;
          const tableList = tables.map((t, i) => `${i + 1}. ${t.name} (${t.table_id})`).join('\n');
          const selected = prompt(`è¯·é€‰æ‹©${type === 'source' ? 'æº' : 'ç›®æ ‡'}è¡¨æ ¼:\n\n${tableList}\n\nè¯·è¾“å…¥åºå·:`);

          if (selected) {
            const index = parseInt(selected) - 1;
            if (index >= 0 && index < tables.length) {
              const targetInput = type === 'source' ? 'sourceTable' : 'targetTable';
              document.getElementById(targetInput).value = tables[index].table_id;
              log(`âœ… å·²é€‰æ‹©${type === 'source' ? 'æº' : 'ç›®æ ‡'}è¡¨æ ¼: ${tables[index].name}`);
              
              // å¦‚æœé€‰æ‹©çš„æ˜¯æºè¡¨æ ¼ï¼Œè‡ªåŠ¨åŠ è½½ä¸»é”®å­—æ®µé€‰é¡¹
              if (type === 'source') {
                await loadPrimaryKeyOptions(tables[index].table_id);
              }
            }
          }
        } else {
          log(`âŒ è·å–è¡¨æ ¼åˆ—è¡¨å¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // åŠ è½½ä¸»é”®å­—æ®µé€‰é¡¹
    async function loadPrimaryKeyOptions(tableId) {
      try {
        const response = await fetch('/api/fields', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            baseId: currentBaseId, 
            personalToken: currentToken,
            tableId: tableId
          })
        });

        const data = await response.json();
        if (data.success) {
          const select = document.getElementById('primaryKeyField');
          select.innerHTML = '<option value="">è‡ªåŠ¨æ£€æµ‹</option>';
          
          data.fields.forEach(field => {
            const option = document.createElement('option');
            option.value = field.field_id;
            option.textContent = `${field.field_name} (${field.type})`;
            select.appendChild(option);
          });
          
          log(`âœ… å·²åŠ è½½ ${data.fields.length} ä¸ªå­—æ®µé€‰é¡¹`);
        }
      } catch (error) {
        log(`âŒ åŠ è½½å­—æ®µå¤±è´¥: ${error.message}`);
      }
    }

    // æ‰§è¡Œæ“ä½œï¼ˆæ ¹æ®é€‰æ‹©çš„æ¨¡å¼ï¼‰
    async function executeOperation() {
      const sourceTable = document.getElementById('sourceTable').value.trim();
      const targetTable = document.getElementById('targetTable').value.trim();
      const operationMode = document.querySelector('input[name="operationMode"]:checked').value;

      if (!sourceTable || !targetTable) {
        return log('â— è¯·å…ˆå¡«å†™æºè¡¨æ ¼å’Œç›®æ ‡è¡¨æ ¼ID');
      }

      if (!currentToken || !currentBaseId) {
        return log('â— è¯·å…ˆå®Œæˆæˆæƒæµ‹è¯•');
      }

      switch (operationMode) {
        case 'preview':
          await previewDifferences();
          break;
        case 'direct':
          await directCopy();
          break;
        case 'mapping':
          await showFieldMapping();
          break;
      }
    }

    // é¢„è§ˆå·®å¼‚
    async function previewDifferences() {
      const sourceTable = document.getElementById('sourceTable').value.trim();
      const targetTable = document.getElementById('targetTable').value.trim();
      const primaryKey = document.getElementById('primaryKeyField').value;

      log('ğŸ” å¼€å§‹åˆ†æå·®å¼‚...');
      
      const operationBtn = document.getElementById('operationBtn');
      operationBtn.disabled = true;
      operationBtn.textContent = 'åˆ†æä¸­...';

      try {
        const response = await fetch('/api/analyze-diff', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceTableId: sourceTable,
            targetTableId: targetTable,
            baseId: currentBaseId,
            personalToken: currentToken,
            primaryKeyField: primaryKey
          })
        });

        const data = await response.json();
        if (data.success) {
          displayDiffResults(data.results);
          log(`âœ… å·®å¼‚åˆ†æå®Œæˆï¼æ–°å¢: ${data.results.new.length}, åˆ é™¤: ${data.results.deleted.length}, ä¿®æ”¹: ${data.results.modified.length}, ç›¸åŒ: ${data.results.same.length}`);
        } else {
          log(`âŒ å·®å¼‚åˆ†æå¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        operationBtn.disabled = false;
        operationBtn.textContent = 'ğŸ” å¼€å§‹åˆ†æ';
      }
    }

    // ç›´æ¥å¤åˆ¶
    async function directCopy() {
      const sourceTable = document.getElementById('sourceTable').value.trim();
      const targetTable = document.getElementById('targetTable').value.trim();

      log('ğŸš€ å¼€å§‹ç›´æ¥å¤åˆ¶...');
      
      const operationBtn = document.getElementById('operationBtn');
      operationBtn.disabled = true;
      operationBtn.textContent = 'å¤åˆ¶ä¸­...';

      try {
        const response = await fetch('/api/copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceTableId: sourceTable,
            targetTableId: targetTable,
            baseId: currentBaseId,
            personalToken: currentToken
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`âœ… å¤åˆ¶å®Œæˆï¼æˆåŠŸå¤åˆ¶ ${data.copied} æ¡è®°å½•`);
        } else {
          log(`âŒ å¤åˆ¶å¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        operationBtn.disabled = false;
        operationBtn.textContent = 'ğŸš€ å¼€å§‹å¤åˆ¶';
      }
    }

    // æ˜¾ç¤ºå­—æ®µæ˜ å°„ç•Œé¢
    async function showFieldMapping() {
      const sourceTable = document.getElementById('sourceTable').value.trim();
      const targetTable = document.getElementById('targetTable').value.trim();

      log('ğŸ¯ æ­£åœ¨åŠ è½½å­—æ®µæ˜ å°„ç•Œé¢...');

      try {
        const [sourceResponse, targetResponse] = await Promise.all([
          fetch('/api/fields', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              baseId: currentBaseId, 
              personalToken: currentToken,
              tableId: sourceTable
            })
          }),
          fetch('/api/fields', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              baseId: currentBaseId, 
              personalToken: currentToken,
              tableId: targetTable
            })
          })
        ]);

        const [sourceData, targetData] = await Promise.all([
          sourceResponse.json(),
          targetResponse.json()
        ]);

        if (sourceData.success && targetData.success) {
          displayFieldMapping(sourceData.fields, targetData.fields);
          document.getElementById('fieldMappingSection').style.display = 'block';
          log(`âœ… å­—æ®µæ˜ å°„ç•Œé¢å·²åŠ è½½`);
        } else {
          log(`âŒ åŠ è½½å­—æ®µä¿¡æ¯å¤±è´¥`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // æ˜¾ç¤ºå·®å¼‚ç»“æœ
    function displayDiffResults(results) {
      const diffResultSection = document.getElementById('diffResultSection');
      const diffSummary = document.getElementById('diffSummary');
      
      diffResultSection.style.display = 'block';
      
      diffSummary.innerHTML = `
        <div class="diff-summary">
          <div class="diff-item diff-new">
            <div class="diff-count">${results.new.length}</div>
            <div>æ–°å¢è®°å½•</div>
          </div>
          <div class="diff-item diff-deleted">
            <div class="diff-count">${results.deleted.length}</div>
            <div>åˆ é™¤è®°å½•</div>
          </div>
          <div class="diff-item diff-modified">
            <div class="diff-count">${results.modified.length}</div>
            <div>ä¿®æ”¹è®°å½•</div>
          </div>
          <div class="diff-item diff-same">
            <div class="diff-count">${results.same.length}</div>
            <div>ç›¸åŒè®°å½•</div>
          </div>
        </div>
        <div style="font-size: 12px; color: #666; margin-top: 8px;">
          ğŸ’¡ æ–°å¢å’Œä¿®æ”¹çš„è®°å½•å°†è¢«å¤åˆ¶åˆ°ç›®æ ‡è¡¨æ ¼
        </div>
      `;
      
      // å­˜å‚¨ç»“æœä¾›åç»­ä½¿ç”¨
      window.diffResults = results;
    }

    // æ‰§è¡Œå¤åˆ¶ï¼ˆåŸºäºå·®å¼‚ç»“æœï¼‰
    async function executeCopy() {
      if (!window.diffResults) {
        return log('âŒ æ²¡æœ‰å·®å¼‚åˆ†æç»“æœ');
      }

      const results = window.diffResults;
      const totalOperations = results.new.length + results.modified.length;
      
      if (totalOperations === 0) {
        return log('â„¹ï¸ æ²¡æœ‰éœ€è¦å¤åˆ¶çš„è®°å½•');
      }

      if (!confirm(`ç¡®å®šè¦æ‰§è¡Œå¤åˆ¶æ“ä½œå—ï¼Ÿ\nå°†å¤„ç† ${totalOperations} æ¡è®°å½•ï¼ˆ${results.new.length} æ–°å¢ï¼Œ${results.modified.length} ä¿®æ”¹ï¼‰`)) {
        return;
      }

      log(`ğŸš€ å¼€å§‹æ‰§è¡Œå¤åˆ¶æ“ä½œï¼Œå…± ${totalOperations} æ¡è®°å½•...`);
      
      const executeCopyBtn = document.getElementById('executeCopyBtn');
      executeCopyBtn.disabled = true;
      executeCopyBtn.textContent = 'æ‰§è¡Œä¸­...';

      try {
        const response = await fetch('/api/execute-diff-copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceTableId: document.getElementById('sourceTable').value.trim(),
            targetTableId: document.getElementById('targetTable').value.trim(),
            baseId: currentBaseId,
            personalToken: currentToken,
            diffResults: results
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`âœ… å¤åˆ¶æ‰§è¡Œå®Œæˆï¼æˆåŠŸ: ${data.successCount}, å¤±è´¥: ${data.errorCount}`);
          if (data.errors && data.errors.length > 0) {
            log(`âš ï¸ éƒ¨åˆ†é”™è¯¯: ${data.errors.slice(0, 3).join(', ')}`);
          }
        } else {
          log(`âŒ å¤åˆ¶æ‰§è¡Œå¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        executeCopyBtn.disabled = false;
        executeCopyBtn.textContent = 'âœ… ç¡®è®¤æ‰§è¡Œå¤åˆ¶';
      }
    }

    // å¯¼å‡ºç»“æœ
    function exportResults() {
      if (!window.diffResults) {
        return log('âŒ æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
      }

      const results = window.diffResults;
      const exportData = {
        timestamp: new Date().toISOString(),
        summary: {
          new: results.new.length,
          deleted: results.deleted.length,
          modified: results.modified.length,
          same: results.same.length
        },
        details: results
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `diff-results-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      log('ğŸ“„ å·®å¼‚ç»“æœå·²å¯¼å‡ºä¸ºJSONæ–‡ä»¶');
    }

    // æ˜¾ç¤ºå­—æ®µæ˜ å°„ç•Œé¢
    function displayFieldMapping(sourceFields, targetFields) {
      const fieldMappingList = document.getElementById('fieldMappingList');
      
      // è‡ªåŠ¨å»ºç«‹å­—æ®µæ˜ å°„
      const autoMapping = {};
      const targetFieldMap = new Map(targetFields.map(f => [f.field_name.toLowerCase(), f]));
      
      let mappingHtml = '';
      sourceFields.forEach(sourceField => {
        const matchedTarget = targetFieldMap.get(sourceField.field_name.toLowerCase());
        const mappedFieldId = matchedTarget ? matchedTarget.field_id : '';
        
        if (matchedTarget) {
          autoMapping[sourceField.field_id] = matchedTarget.field_id;
        }
        
        mappingHtml += `
          <div class="mapping-row">
            <div class="source-field">
              <div class="field-info">
                <div class="field-name">${sourceField.field_name}</div>
                <div class="field-type">${sourceField.type}</div>
              </div>
              <span class="mapping-status ${matchedTarget ? 'status-mapped' : 'status-unmapped'}">
                ${matchedTarget ? 'å·²æ˜ å°„' : 'æœªæ˜ å°„'}
              </span>
            </div>
            <div class="target-field">
              <select class="mapping-select" data-source-field="${sourceField.field_id}" onchange="updateMappingStatus(this)">
                <option value="">-- é€‰æ‹©ç›®æ ‡å­—æ®µ --</option>
                ${targetFields.map(tf => 
                  `<option value="${tf.field_id}" ${tf.field_id === mappedFieldId ? 'selected' : ''}>${tf.field_name} (${tf.type})</option>`
                ).join('')}
              </select>
            </div>
          </div>
        `;
      });
      
      fieldMappingList.innerHTML = mappingHtml;
      
      // å­˜å‚¨å½“å‰æ˜ å°„
      window.currentFieldMapping = autoMapping;
      
      log(`âœ… è‡ªåŠ¨æ˜ å°„äº† ${Object.keys(autoMapping).length} ä¸ªå­—æ®µ`);
    }

    // æ›´æ–°æ˜ å°„çŠ¶æ€
    function updateMappingStatus(selectElement) {
      const row = selectElement.closest('.mapping-row');
      const statusElement = row.querySelector('.mapping-status');
      const sourceFieldId = selectElement.dataset.sourceField;
      
      if (selectElement.value) {
        statusElement.textContent = 'å·²æ˜ å°„';
        statusElement.className = 'mapping-status status-mapped';
        window.currentFieldMapping[sourceFieldId] = selectElement.value;
      } else {
        statusElement.textContent = 'æœªæ˜ å°„';
        statusElement.className = 'mapping-status status-unmapped';
        delete window.currentFieldMapping[sourceFieldId];
      }
    }

    // ä½¿ç”¨æ˜ å°„æ‰§è¡Œå¤åˆ¶
    async function executeWithMapping() {
      if (!window.currentFieldMapping || Object.keys(window.currentFieldMapping).length === 0) {
        return log('â— è¯·è‡³å°‘é…ç½®ä¸€ä¸ªå­—æ®µæ˜ å°„');
      }

      const sourceTable = document.getElementById('sourceTable').value.trim();
      const targetTable = document.getElementById('targetTable').value.trim();

      log(`ğŸš€ å¼€å§‹ä½¿ç”¨è‡ªå®šä¹‰æ˜ å°„å¤åˆ¶æ•°æ®...`);
      
      const executeMappingBtn = document.getElementById('executeMappingBtn');
      executeMappingBtn.disabled = true;
      executeMappingBtn.textContent = 'å¤åˆ¶ä¸­...';

      try {
        const response = await fetch('/api/copy-with-mapping', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceTableId: sourceTable,
            targetTableId: targetTable,
            baseId: currentBaseId,
            personalToken: currentToken,
            fieldMapping: window.currentFieldMapping
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`âœ… æ˜ å°„å¤åˆ¶å®Œæˆï¼æˆåŠŸå¤åˆ¶ ${data.copied} æ¡è®°å½•`);
        } else {
          log(`âŒ æ˜ å°„å¤åˆ¶å¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      } finally {
        executeMappingBtn.disabled = false;
        executeMappingBtn.textContent = 'ğŸš€ ä½¿ç”¨æ˜ å°„æ‰§è¡Œå¤åˆ¶';
      }
    }

    // ç›‘å¬æ“ä½œæ¨¡å¼å˜åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('input[name="operationMode"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const operationBtn = document.getElementById('operationBtn');
          const selectedMode = document.querySelector('input[name="operationMode"]:checked').value;
          
          switch (selectedMode) {
            case 'preview':
              operationBtn.textContent = 'ğŸ” å¼€å§‹åˆ†æ';
              break;
            case 'direct':
              operationBtn.textContent = 'ğŸš€ å¼€å§‹å¤åˆ¶';
              break;
            case 'mapping':
              operationBtn.textContent = 'ğŸ¯ é…ç½®æ˜ å°„';
              break;
          }
        });
      });
    });

    // æ—¥å¿—å‡½æ•°
    function log(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }
  </script>
</body>

</html>