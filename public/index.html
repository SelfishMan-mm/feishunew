<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>é£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®å¤åˆ¶å·¥å…·</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header {
      background: #4285f4;
      color: white;
      padding: 20px;
      border-radius: 8px 8px 0 0;
    }

    .content {
      padding: 20px;
    }

    .section {
      margin-bottom: 30px;
    }

    .section h3 {
      color: #333;
      border-bottom: 2px solid #4285f4;
      padding-bottom: 5px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }

    .form-row {
      display: flex;
      gap: 15px;
      align-items: end;
    }

    .form-row>div {
      flex: 1;
    }

    input,
    select,
    button {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 5px rgba(66, 133, 244, 0.3);
    }

    button {
      background: #4285f4;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #3367d6;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #log {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
    }

    small {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>é£ä¹¦å¤šç»´è¡¨æ ¼æ•°æ®å¤åˆ¶å·¥å…·</h1>
      <p>æ”¯æŒåŠ¨æ€æˆæƒï¼Œé€šç”¨äºä»»æ„Base</p>
    </div>

    <div class="content">
      <!-- æˆæƒé…ç½® -->
      <div class="section">
        <h3>ğŸ” æˆæƒé…ç½®</h3>
        <div class="form-group">
          <label>Base IDï¼ˆè‡ªåŠ¨è·å–ï¼‰</label>
          <input id="baseId" placeholder="è‡ªåŠ¨ä»URLè·å–..." readonly />
        </div>
        <div class="form-group">
          <label>PersonalBaseTokenï¼ˆå¿…å¡«ï¼‰</label>
          <input id="personalToken" placeholder="è¯·è¾“å…¥æ­¤Baseçš„PersonalBaseToken" type="password" />
          <small>ğŸ’¡ æ¯ä¸ªBaseéƒ½æœ‰ç‹¬ç«‹çš„æˆæƒç ï¼Œè¯·åœ¨å¤šç»´è¡¨æ ¼è®¾ç½®ä¸­è·å–</small>
        </div>
        <div class="form-row">
          <button onclick="testAuth()">ğŸ” æµ‹è¯•æˆæƒ</button>
        </div>
      </div>

      <!-- è¡¨æ ¼é€‰æ‹© -->
      <div class="section" id="tableSection" style="display:none;">
        <h3>ğŸ“‹ è¡¨æ ¼é€‰æ‹©</h3>
        <div class="form-row">
          <div>
            <label>æºè¡¨æ ¼ID</label>
            <input id="sourceTable" placeholder="è¾“å…¥è¡¨æ ¼ID (tblXXXXXX)" />
            <button type="button" onclick="showTableSelector('source')">ğŸ“‹ é€‰æ‹©è¡¨æ ¼</button>
          </div>
          <div>
            <label>ç›®æ ‡è¡¨æ ¼ID</label>
            <input id="targetTable" placeholder="è¾“å…¥è¡¨æ ¼ID (tblYYYYYY)" />
            <button type="button" onclick="showTableSelector('target')">ğŸ“‹ é€‰æ‹©è¡¨æ ¼</button>
          </div>
        </div>
        <div class="form-row">
          <button onclick="startCopy()">ğŸš€ å¼€å§‹å¤åˆ¶</button>
        </div>
      </div>

      <!-- æ—¥å¿— -->
      <div class="section">
        <h3>ğŸ“ æ“ä½œæ—¥å¿—</h3>
        <pre id="log">ç­‰å¾…æ“ä½œ...</pre>
      </div>
    </div>
  </div>

  <script>
    let currentBaseId = null;
    let currentToken = null;

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–BaseId
    window.addEventListener('load', () => {
      autoDetectBaseId();
    });

    // è‡ªåŠ¨ä»URLè·å–BaseId
    function autoDetectBaseId() {
      const currentUrl = window.location.href;
      const baseIdMatch = currentUrl.match(/\/base\/([a-zA-Z0-9]+)/);

      if (baseIdMatch) {
        currentBaseId = baseIdMatch[1];
        document.getElementById('baseId').value = currentBaseId;
        log(`âœ… è‡ªåŠ¨è·å–BaseId: ${currentBaseId}`);
      } else {
        // å¦‚æœæ— æ³•è‡ªåŠ¨è·å–ï¼Œä½¿ç”¨é»˜è®¤å€¼
        currentBaseId = 'KnX9bIOTKaE3trspPCycfFMjnkg';
        document.getElementById('baseId').value = currentBaseId + ' (é»˜è®¤)';
        log('âš ï¸ æ— æ³•è‡ªåŠ¨è·å–BaseIdï¼Œä½¿ç”¨é»˜è®¤å€¼');
      }
    }

    // æµ‹è¯•æˆæƒ
    async function testAuth() {
      const token = document.getElementById('personalToken').value.trim();
      const baseId = document.getElementById('baseId').value.replace(' (é»˜è®¤)', '').trim();

      if (!token) {
        return log('â— è¯·è¾“å…¥PersonalBaseToken');
      }

      if (!baseId) {
        return log('â— BaseIdä¸èƒ½ä¸ºç©º');
      }

      log('ğŸ” æ­£åœ¨æµ‹è¯•æˆæƒ...');

      try {
        const response = await fetch('/api/test-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId, personalToken: token })
        });

        const data = await response.json();
        if (data.success) {
          currentToken = token;
          currentBaseId = baseId;
          document.getElementById('tableSection').style.display = 'block';
          log(`âœ… æˆæƒæˆåŠŸï¼å¯è®¿é—® ${data.tableCount} ä¸ªè¡¨æ ¼`);
        } else {
          log(`âŒ æˆæƒå¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ æµ‹è¯•æˆæƒå¤±è´¥: ${error.message}`);
      }
    }

    // æ˜¾ç¤ºè¡¨æ ¼é€‰æ‹©å™¨
    async function showTableSelector(type) {
      if (!currentToken || !currentBaseId) {
        return log('â— è¯·å…ˆå®Œæˆæˆæƒæµ‹è¯•');
      }

      log('ğŸ“‹ æ­£åœ¨è·å–è¡¨æ ¼åˆ—è¡¨...');

      try {
        const response = await fetch('/api/tables', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ baseId: currentBaseId, personalToken: currentToken })
        });

        const data = await response.json();
        if (data.success) {
          const tables = data.tables;
          const tableList = tables.map((t, i) => `${i + 1}. ${t.name} (${t.table_id})`).join('\n');
          const selected = prompt(`è¯·é€‰æ‹©${type === 'source' ? 'æº' : 'ç›®æ ‡'}è¡¨æ ¼:\n\n${tableList}\n\nè¯·è¾“å…¥åºå·:`);

          if (selected) {
            const index = parseInt(selected) - 1;
            if (index >= 0 && index < tables.length) {
              const targetInput = type === 'source' ? 'sourceTable' : 'targetTable';
              document.getElementById(targetInput).value = tables[index].table_id;
              log(`âœ… å·²é€‰æ‹©${type === 'source' ? 'æº' : 'ç›®æ ‡'}è¡¨æ ¼: ${tables[index].name}`);
            }
          }
        } else {
          log(`âŒ è·å–è¡¨æ ¼åˆ—è¡¨å¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // å¼€å§‹å¤åˆ¶
    async function startCopy() {
      const sourceTable = document.getElementById('sourceTable').value.trim();
      const targetTable = document.getElementById('targetTable').value.trim();

      if (!sourceTable || !targetTable) {
        return log('â— è¯·å…ˆå¡«å†™æºè¡¨æ ¼å’Œç›®æ ‡è¡¨æ ¼ID');
      }

      if (!currentToken || !currentBaseId) {
        return log('â— è¯·å…ˆå®Œæˆæˆæƒæµ‹è¯•');
      }

      log('ğŸš€ å¼€å§‹å¤åˆ¶æ•°æ®...');

      try {
        const response = await fetch('/api/copy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceTableId: sourceTable,
            targetTableId: targetTable,
            baseId: currentBaseId,
            personalToken: currentToken
          })
        });

        const data = await response.json();
        if (data.success) {
          log(`âœ… å¤åˆ¶å®Œæˆï¼æˆåŠŸå¤åˆ¶ ${data.copied} æ¡è®°å½•`);
        } else {
          log(`âŒ å¤åˆ¶å¤±è´¥: ${data.error}`);
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
      }
    }

    // æ—¥å¿—å‡½æ•°
    function log(message) {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      logElement.textContent += `[${timestamp}] ${message}\n`;
      logElement.scrollTop = logElement.scrollHeight;
    }
  </script>
</body>

</html>